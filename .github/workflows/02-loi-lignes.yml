name: "ğŸ“ NIVEAU 2 : GÃ©nÃ©ral MÃ©treur - Loi Lignes"
run-name: "ğŸ“ Audit Lignes - ChaÃ®ne ComplÃ¨te 10 Workflows"

on:
  workflow_call:
    inputs:
      limite_lignes:
        description: "Limite maximum de lignes par fichier"
        required: false
        default: 500
        type: number
      extensions_cibles:
        description: "Extensions Ã  analyser"
        required: false
        default: "py,js,yml"
        type: string
      repertoire_analyse:
        description: "RÃ©pertoire Ã  analyser"
        required: false
        default: "."
        type: string
      audit_id:
        description: "Identifiant unique de l'audit"
        required: false
        type: string
        default: "audit-lignes"

    outputs:
      audit_reussi:
        description: "RÃ©sultat final de l'audit lignes"
        value: ${{ jobs.conseiller_final.outputs.audit_conforme }}
      statistiques_finales:
        description: "Statistiques complÃ¨tes"
        value: ${{ jobs.statisticien.outputs.statistiques_json }}
      rapport_final:
        description: "Rapport formatÃ©"
        value: ${{ jobs.formater_rapport.outputs.rapport_md }}

jobs:
  # Ã‰TAPE 1: Scanner les fichiers (Niveau 6)
  scanner_fichiers:
    name: "ğŸ” Scanner Fichiers"
    uses: ./.github/workflows/06-01_scanner-fichiers.yml
    with:
      dossiers_cibles: ${{ inputs.repertoire_analyse }}
      extensions_cibles: ${{ inputs.extensions_cibles }}
      patterns_exclusion: '["__pycache__", ".git", "node_modules"]'

  # Ã‰TAPE 2: Compter les lignes (Niveau 4 - Ouvrier 1)
  compteur:
    name: "ğŸ“Š Compteur de Lignes"
    needs: scanner_fichiers
    uses: ./.github/workflows/04-01-lignes-compteur.yml
    with:
      liste_fichiers: ${{ needs.scanner_fichiers.outputs.fichiers_trouves }}
      options_comptage: '["code", "comments", "blank"]'

  # Ã‰TAPE 3: Valider comptage (Niveau 5 - Qualiticien 1)
  valider_compteur:
    name: "âœ… Valider Comptage"
    needs: compteur
    uses: ./.github/workflows/05-01-lignes-valid-compteur.yml
    with:
      resultats_comptage: ${{ needs.compteur.outputs.resultats_bruts }}
      schema_attendu: "comptage-lignes-v1"

  # Ã‰TAPE 4: Juger conformitÃ© (Niveau 4 - Ouvrier 2)
  juge:
    name: "âš–ï¸ Juge de ConformitÃ©"
    needs: [compteur, valider_compteur]
    if: needs.valider_compteur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-02-lignes-juge.yml
    with:
      resultats_comptage: ${{ needs.compteur.outputs.resultats_bruts }}
      limite_lignes: ${{ inputs.limite_lignes }}
      severite_violations: "critique"

  # Ã‰TAPE 5: Valider jugement (Niveau 5 - Qualiticien 2)
  valider_juge:
    name: "âœ… Valider Jugement"
    needs: juge
    uses: ./.github/workflows/05-02-lignes-valid-juge.yml
    with:
      resultats_jugement: ${{ needs.juge.outputs.violations_detectees }}
      schema_attendu: "jugement-lignes-v1"

  # Ã‰TAPE 6: Calculer statistiques (Niveau 4 - Ouvrier 3)
  statisticien:
    name: "ğŸ“ˆ Statisticien"
    needs: [juge, valider_juge]
    if: needs.valider_juge.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-03-lignes-statisticien.yml
    with:
      donnees_jugement: ${{ needs.juge.outputs.violations_detectees }}
      calculs_avances: true
      metriques_globales: true

  # Ã‰TAPE 7: Valider statistiques (Niveau 5 - Qualiticien 3)
  valider_statisticien:
    name: "âœ… Valider Statistiques"
    needs: statisticien
    uses: ./.github/workflows/05-03-lignes-valid-statisticien.yml
    with:
      statistiques: ${{ needs.statisticien.outputs.statistiques_json }}
      schema_attendu: "statistiques-lignes-v1"

  # Ã‰TAPE 8: GÃ©nÃ©rer rapport (Niveau 4 - Ouvrier 4)
  rapporteur:
    name: "ğŸ“‹ Rapporteur"
    needs: [statisticien, valider_statisticien]
    if: needs.valider_statisticien.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-04-lignes-rapporteur.yml
    with:
      statistiques_validees: ${{ needs.statisticien.outputs.statistiques_json }}
      template_rapport: "rapport-lignes-detaille"
      format_sortie: "json"

  # Ã‰TAPE 9: Valider rapport (Niveau 5 - Qualiticien 4)
  valider_rapporteur:
    name: "âœ… Valider Rapport"
    needs: rapporteur
    uses: ./.github/workflows/05-04-lignes-valid-rapporteur.yml
    with:
      rapport_genere: ${{ needs.rapporteur.outputs.rapport_brut }}
      schema_attendu: "rapport-lignes-v1"

  # Ã‰TAPE 10: Conseil final (Niveau 4 - Ouvrier 5)
  conseiller_final:
    name: "ğŸ¯ Conseiller Final"
    needs: [rapporteur, valider_rapporteur]
    if: needs.valider_rapporteur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-05-lignes-conseiller.yml
    with:
      rapport_valide: ${{ needs.rapporteur.outputs.rapport_brut }}
      seuil_conformite: ${{ inputs.limite_lignes }}
      recommandations: true

  # Ã‰TAPE 11: Valider conseil (Niveau 5 - Qualiticien 5)
  valider_conseiller:
    name: "âœ… Valider Conseil"
    needs: conseiller_final
    uses: ./.github/workflows/05-05-lignes-valid-conseiller.yml
    with:
      conseil_final: ${{ needs.conseiller_final.outputs.conseil_json }}
      schema_attendu: "conseil-lignes-v1"

  # Ã‰TAPE 12: Formater rapport final (Niveau 7)
  formater_rapport:
    name: "ğŸ“„ Formater Rapport"
    needs: [conseiller_final, valider_conseiller]
    if: needs.valider_conseiller.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/07-02_formateur-markdown.yml
    with:
      artefact_entree_json: ${{ needs.conseiller_final.outputs.conseil_json }}
      template_markdown: "rapport-audit-lignes-complet"

  # Ã‰TAPE 13: Statut final (Niveau 7)
  statut_final:
    name: "ğŸ“¢ Statut Final"
    needs: [conseiller_final, valider_conseiller, formater_rapport]
    if: always()
    uses: ./.github/workflows/07-03_formateur-statut.yml
    with:
      resultat: ${{ needs.conseiller_final.outputs.audit_conforme == 'true' && needs.valider_conseiller.outputs.validation_reussie == 'true' }}
      message_succes: "âœ… Audit Lignes CONFORME - Limite: ${{ inputs.limite_lignes }}"
      message_echec: "âŒ Audit Lignes NON CONFORME - Violations dÃ©tectÃ©es"
      nom_check: "Loi Lignes"
