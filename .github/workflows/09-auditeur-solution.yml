name: "üîç NIVEAU 2 : G√©n√©ral Auditeur - Audit de Solution"
run-name: "üîç Auditeur - Qualification Compl√®te de Solution"

on:
  workflow_call:
    inputs:
      solution_a_auditer:
        description: "Solution √† auditer"
        required: true
        type: string
      niveau_confiance_requis:
        description: "Niveau de confiance requis (0-100)"
        required: false
        default: 80
        type: number

    outputs:
      audit_reussi:
        description: "Audit r√©ussi"
        value: ${{ jobs.valider_plan.outputs.validation_reussie == 'true' }}
      score_confiance:
        description: "Score de confiance final"
        value: ${{ jobs.plan_implementation.outputs.score_final }}
      plan_implementation:
        description: "Plan d'impl√©mentation"
        value: ${{ jobs.plan_implementation.outputs.plan_json }}

jobs:
  # √âTAPE 1: Audit du sch√©ma (Niveau 4 - Ouvrier 1)
  audit_schema:
    name: "üìã Audit Sch√©ma"
    uses: ./.github/workflows/04-01-auditeur-schema.yml
    with:
      solution_input: ${{ inputs.solution_a_auditer }}
      schema_requis: "solution-standard-v1"
      validation_stricte: true

  # √âTAPE 2: Valider sch√©ma (Niveau 5 - Qualiticien 1)
  valider_schema:
    name: "‚úÖ Valider Sch√©ma"
    needs: audit_schema
    uses: ./.github/workflows/05-01-auditeur-valid-schema.yml
    with:
      rapport_schema: ${{ needs.audit_schema.outputs.rapport_validation }}
      schema_attendu: "rapport-schema-v1"

  # √âTAPE 3: Audit s√©curit√© (Niveau 4 - Ouvrier 2)
  audit_securite_solution:
    name: "üõ°Ô∏è Audit S√©curit√© Solution"
    needs: [audit_schema, valider_schema]
    if: needs.valider_schema.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-02-auditeur-securite.yml
    with:
      solution_validee: ${{ needs.audit_schema.outputs.solution_normalisee }}
      niveau_analyse: "approfondi"
      tests_penetration: true

  # √âTAPE 4: Valider s√©curit√© (Niveau 5 - Qualiticien 2)
  valider_securite:
    name: "‚úÖ Valider S√©curit√©"
    needs: audit_securite_solution
    uses: ./.github/workflows/05-02-auditeur-valid-securite.yml
    with:
      rapport_securite: ${{ needs.audit_securite_solution.outputs.analyse_securite }}
      schema_attendu: "rapport-securite-v1"

  # √âTAPE 5: Simulation (Niveau 4 - Ouvrier 3)
  simulation_solution:
    name: "üß™ Simulation Solution"
    needs: [audit_securite_solution, valider_securite]
    if: needs.valider_securite.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-03-auditeur-simulation.yml
    with:
      solution_securisee: ${{ needs.audit_securite_solution.outputs.solution_securisee }}
      scenarios_test: "nominal,degraded,extreme"
      duree_simulation: "300"

  # √âTAPE 6: Valider simulation (Niveau 5 - Qualiticien 3)
  valider_simulation:
    name: "‚úÖ Valider Simulation"
    needs: simulation_solution
    uses: ./.github/workflows/05-03-auditeur-valid-simulation.yml
    with:
      resultats_simulation: ${{ needs.simulation_solution.outputs.resultats_complets }}
      schema_attendu: "resultats-simulation-v1"

  # √âTAPE 7: Analyse co√ªt (Niveau 4 - Ouvrier 4)
  analyse_cout:
    name: "üí∞ Analyse Co√ªt"
    needs: [simulation_solution, valider_simulation]
    if: needs.valider_simulation.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-04-auditeur-cout.yml
    with:
      solution_simulee: ${{ needs.simulation_solution.outputs.solution_optimisee }}
      parametres_cout: '{"ressources_cpu": true, "memoire": true, "stockage": true, "reseau": true}'
      horizon_temporel: "12_mois"

  # √âTAPE 8: Valider co√ªt (Niveau 5 - Qualiticien 4)
  valider_cout:
    name: "‚úÖ Valider Co√ªt"
    needs: analyse_cout
    uses: ./.github/workflows/05-04-auditeur-valid-cout.yml
    with:
      analyse_cout: ${{ needs.analyse_cout.outputs.estimation_detaillee }}
      schema_attendu: "analyse-cout-v1"

  # √âTAPE 9: Plan d'impl√©mentation (Niveau 4 - Ouvrier 5)
  plan_implementation:
    name: "üìä Plan d'Impl√©mentation"
    needs: [analyse_cout, valider_cout]
    if: needs.valider_cout.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-05-auditeur-plan.yml
    with:
      solution_complete: ${{ needs.analyse_cout.outputs.solution_evaluee }}
      niveau_confiance_cible: ${{ inputs.niveau_confiance_requis }}
      inclure_risques: true
      inclure_timeline: true

  # √âTAPE 10: Valider plan (Niveau 5 - Qualiticien 5)
  valider_plan:
    name: "‚úÖ Valider Plan Final"
    needs: plan_implementation
    uses: ./.github/workflows/05-05-auditeur-valid-plan.yml
    with:
      plan_implementation: ${{ needs.plan_implementation.outputs.plan_json }}
      schema_attendu: "plan-implementation-v1"
      verification_coherence: true

  # √âTAPE 11: Rapport final
  rapport_final_auditeur:
    name: "üìã Rapport Final Auditeur"
    needs: [plan_implementation, valider_plan]
    if: needs.valider_plan.outputs.validation_reussie == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: "üìä Synth√®se Audit Solution"
      run: |
        echo "üîç RAPPORT FINAL - AUDIT DE SOLUTION"
        echo "===================================="
        echo "Score de confiance: ${{ needs.plan_implementation.outputs.score_final }}%"
        echo "Seuil requis: ${{ inputs.niveau_confiance_requis }}%"
        echo "Statut: $([ '${{ needs.plan_implementation.outputs.score_final }}' -ge '${{ inputs.niveau_confiance_requis }}' ] && echo 'CONFORME ‚úÖ' || echo 'NON CONFORME ‚ùå')"
        echo ""
        echo "√âtapes valid√©es:"
        echo "- Sch√©ma: ${{ needs.valider_schema.outputs.validation_reussie }}"
        echo "- S√©curit√©: ${{ needs.valider_securite.outputs.validation_reussie }}"
        echo "- Simulation: ${{ needs.valider_simulation.outputs.validation_reussie }}"
        echo "- Co√ªt: ${{ needs.valider_cout.outputs.validation_reussie }}"
        echo "- Plan: ${{ needs.valider_plan.outputs.validation_reussie }}"
