name: Master Auto-Fix All Errors

on:
  push:
    branches: [ agi-main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  auto-fix-all-errors:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort pyyaml
      
      - name: Fix Special Characters
        run: |
          echo "Removing special characters from workflows..."
          find .github/workflows/ -name "*.yml" -exec sed -i 's/[📊🎭🎯🔧🚀⚡🔍✅❌⚠️]//g' {} \;
      
      - name: Fix Fake Dependencies
        run: |
          echo "Removing fake packages..."
          find .github/workflows/ -name "*.yml" -exec sed -i '/constitutional-analysis/d' {} \;
          find .github/workflows/ -name "*.yml" -exec sed -i '/compliance-checker/d' {} \;
          find .github/workflows/ -name "*.yml" -exec sed -i '/physics-engine/d' {} \;
          find .github/workflows/ -name "*.yml" -exec sed -i '/brain-cognitive-toolkit/d' {} \;
      
      - name: Fix Obsolete Actions
        run: |
          echo "Updating obsolete actions..."
          find .github/workflows/ -name "*.yml" -exec sed -i 's/@v3/@v4/g' {} \;
          find .github/workflows/ -name "*.yml" -exec sed -i 's/@v2/@v4/g' {} \;
      
      - name: Fix Environment Syntax
        run: |
          echo "Fixing env syntax..."
          find .github/workflows/ -name "*.yml" -exec sed -i 's/env::/env:/g' {} \;
      
      - name: Fix Python Files
        run: |
          echo "Formatting Python files..."
          find . -name "*.py" -not -path "./.venv/*" -exec black --line-length 88 {} \; || echo "Black completed"
      
      - name: Check Changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit Fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Auto Fix Bot"
          git add -A
          git commit -m "auto-fix: Corrections automatiques appliquees"
      
      - name: Push Changes
        if: steps.changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: agi-main
