name: ðŸ¤– Development Automation Pipeline

on:
  push:
    paths: ['eve/development/**']
  pull_request:
    paths: ['eve/development/**']
  workflow_dispatch:

jobs:
  dev-automation:
    name: Development Pipeline Automation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Development Environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Development Tools
      run: |
        pip install automation-tools development-pipeline
        pip install black isort flake8 mypy pytest
        pip install pre-commit git-hooks-manager
        
    - name: EVE Development Tools Integration
      run: |
        echo "ðŸ¤– PIPELINE AUTOMATISATION EVE" > automation-report.md
        echo "==============================" >> automation-report.md
        echo "" >> automation-report.md
        
        # Analyser outils dÃ©veloppement EVE
        if [ -d "eve/development" ]; then
          echo "## ðŸ› ï¸ Outils DÃ©veloppement EVE" >> automation-report.md
          
          modules=("code_analysis" "monitoring" "git_integration" "automation")
          
          for module in "${modules[@]}"; do
            if [ -d "eve/development/$module" ]; then
              file_count=$(find "eve/development/$module" -name "*.py" | wc -l)
              echo "- **$module**: $file_count modules" >> automation-report.md
            else
              echo "- **$module**: âš ï¸ Non trouvÃ©" >> automation-report.md
            fi
          done
          
          echo "" >> automation-report.md
        fi
        
    - name: Automated Code Quality Pipeline
      run: |
        echo "## ðŸ” Pipeline QualitÃ© Automatique" >> automation-report.md
        echo "" >> automation-report.md
        
        # Formatage automatique
        echo "### ðŸŽ¨ Formatage Code" >> automation-report.md
        
        # Black formatting
        if black --check --diff . >/dev/null 2>&1; then
          echo "- âœ… **Black**: Code correctement formatÃ©" >> automation-report.md
        else
          echo "- âš ï¸ **Black**: Formatage requis" >> automation-report.md
          # Appliquer formatage en mode dry-run
          black --check --diff . > black_changes.txt 2>&1 || true
          echo "  - $(wc -l < black_changes.txt) lignes Ã  reformater" >> automation-report.md
        fi
        
        # Import sorting
        if isort --check-only --diff . >/dev/null 2>&1; then
          echo "- âœ… **isort**: Imports correctement triÃ©s" >> automation-report.md
        else
          echo "- âš ï¸ **isort**: Tri imports requis" >> automation-report.md
        fi
        
        echo "" >> automation-report.md
        
    - name: Automated Testing Pipeline
      run: |
        echo "## ðŸ§ª Pipeline Tests Automatiques" >> automation-report.md
        echo "" >> automation-report.md
        
        # DÃ©couverte des tests
        test_files=$(find . -name "test_*.py" -o -name "*_test.py" | wc -l)
        echo "- **Fichiers de test**: $test_files dÃ©tectÃ©s" >> automation-report.md
        
        if [ $test_files -gt 0 ]; then
          # ExÃ©cuter tests avec pytest
          if pytest --collect-only -q >/dev/null 2>&1; then
            echo "- âœ… **Tests**: Configuration valide" >> automation-report.md
            
            # Couverture de code
            if pytest --cov=. --cov-report=term --cov-report=xml -v > pytest_output.txt 2>&1; then
              coverage=$(grep -o 'TOTAL.*[0-9]\+%' pytest_output.txt | grep -o '[0-9]\+%' | head -1 || echo "N/A")
              echo "- **Couverture**: $coverage" >> automation-report.md
            else
              echo "- âš ï¸ **Tests**: Certains tests Ã©chouent" >> automation-report.md
            fi
          else
            echo "- âš ï¸ **Tests**: Configuration Ã  corriger" >> automation-report.md
          fi
        else
          echo "- âš ï¸ **Tests**: Aucun test trouvÃ© - Tests Ã  crÃ©er" >> automation-report.md
        fi
        
        echo "" >> automation-report.md
        
    - name: Automated Documentation Pipeline
      run: |
        echo "## ðŸ“š Pipeline Documentation Automatique" >> automation-report.md
        echo "" >> automation-report.md
        
        # VÃ©rifier documentation
        readme_files=$(find . -iname "readme*" | wc -l)
        doc_files=$(find . -name "*.md" | wc -l)
        
        echo "- **README**: $readme_files fichier(s)" >> automation-report.md
        echo "- **Documentation Markdown**: $doc_files fichier(s)" >> automation-report.md
        
        # VÃ©rifier docstrings
        python -c "
        import ast
        import os
        
        total_functions = 0
        documented_functions = 0
        
        for root, dirs, files in os.walk('.'):
            if '.git' in root:
                continue
            for file in files:
                if file.endswith('.py'):
                    filepath = os.path.join(root, file)
                    try:
                        with open(filepath, 'r', encoding='utf-8') as f:
                            tree = ast.parse(f.read())
                        
                        for node in ast.walk(tree):
                            if isinstance(node, ast.FunctionDef):
                                total_functions += 1
                                if ast.get_docstring(node):
                                    documented_functions += 1
                    except:
                        pass
        
        if total_functions > 0:
            doc_percentage = (documented_functions / total_functions) * 100
            print(f'- **Docstrings**: {documented_functions}/{total_functions} fonctions ({doc_percentage:.1f}%)')
            
            if doc_percentage >= 80:
                print('- âœ… **Documentation**: Bonne couverture')
            elif doc_percentage >= 50:
                print('- âš ï¸ **Documentation**: Couverture moyenne')
            else:
                print('- âŒ **Documentation**: Couverture faible')
        else:
            print('- **Docstrings**: Aucune fonction analysÃ©e')
        " >> automation-report.md
        
        echo "" >> automation-report.md
        
    - name: Automated Deployment Preparation
      run: |
        echo "## ðŸš€ PrÃ©paration DÃ©ploiement Automatique" >> automation-report.md
        echo "" >> automation-report.md
        
        # VÃ©rifier configuration dÃ©ploiement
        deploy_configs=("Dockerfile" "requirements.txt" "setup.py" "pyproject.toml")
        
        for config in "${deploy_configs[@]}"; do
          if [ -f "$config" ]; then
            echo "- âœ… **$config**: PrÃ©sent" >> automation-report.md
          else
            echo "- âš ï¸ **$config**: Manquant" >> automation-report.md
          fi
        done
        
        # VÃ©rifier structure packaging
        if [ -d "eve" ] && [ -d "core" ]; then
          echo "- âœ… **Structure**: Modules principaux dÃ©tectÃ©s" >> automation-report.md
        else
          echo "- âš ï¸ **Structure**: Structure projet Ã  valider" >> automation-report.md
        fi
        
        # VÃ©rifier conformitÃ© AGI
        if ls conformite_*.csv >/dev/null 2>&1; then
          latest_conformity=$(ls -t conformite_*.csv | head -1)
          violations=$(grep -c "VIOLATION" "$latest_conformity" 2>/dev/null || echo "0")
          echo "- **ConformitÃ© AGI**: $violations violations dÃ©tectÃ©es" >> automation-report.md
          
          if [ $violations -eq 0 ]; then
            echo "- âœ… **PrÃªt dÃ©ploiement**: ConformitÃ© respectÃ©e" >> automation-report.md
          else
            echo "- âš ï¸ **PrÃªt dÃ©ploiement**: Violations Ã  corriger" >> automation-report.md
          fi
        else
          echo "- âš ï¸ **ConformitÃ©**: Rapport non trouvÃ©" >> automation-report.md
        fi
        
    - name: Upload Automation Reports
      uses: actions/upload-artifact@v4
      with:
        name: development-automation-report
        path: |
          automation-report.md
          black_changes.txt
          pytest_output.txt
          coverage.xml
