name: "Travailleur : Archiveur ZIP"

on:
  workflow_call:
    inputs:
      nom_archive:
        description: "Nom de l'archive ZIP à créer"
        required: true
        type: string
      fichiers_a_zipper:
        description: "Liste des fichiers à archiver (JSON array)"
        required: true
        type: string
    outputs:
      archive_path:
        description: "Chemin vers l'archive créée"
        value: ${{ jobs.create_zip.outputs.path }}
      archive_size:
        description: "Taille de l'archive en bytes"
        value: ${{ jobs.create_zip.outputs.size }}

jobs:
  create_zip:
    name: "Création archive ZIP"
    runs-on: ubuntu-latest
    outputs:
      path: ${{ steps.zip.outputs.archive_path }}
      size: ${{ steps.zip.outputs.archive_size }}
    
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
      
      - name: "Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: "Créer ZIP"
        id: zip
        run: |
          echo "Création archive ZIP..."
          
          if python .github/scripts/travailleur_archiveur_zip.py \
            --nom-archive "${{ inputs.nom_archive }}" \
            --fichiers '${{ inputs.fichiers_a_zipper }}'; then
            
            echo "Archive ZIP créée"
            
            if [ -f "${{ inputs.nom_archive }}" ]; then
              archive_size=$(stat -c%s "${{ inputs.nom_archive }}")
              
              echo "archive_path=${{ inputs.nom_archive }}" >> $GITHUB_OUTPUT
              echo "archive_size=$archive_size" >> $GITHUB_OUTPUT
              
              echo "Archive créée - $archive_size bytes"
            else
              echo "ERREUR: Archive non créée"
              echo "archive_path=" >> $GITHUB_OUTPUT
              echo "archive_size=0" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "ERREUR: Script archiveur a échoué"
            echo "archive_path=" >> $GITHUB_OUTPUT
            echo "archive_size=0" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: "Upload archive"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.nom_archive }}
          path: ${{ inputs.nom_archive }}
          retention-days: 30
