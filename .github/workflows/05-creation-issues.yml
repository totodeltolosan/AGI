name: "ðŸŽ« GÃ©nÃ©ral Le Greffier - CrÃ©ation Issues"

on:
  workflow_call:
    inputs:
      noms_artefacts:
        description: "Liste des noms d'artefacts de rapport Ã  analyser (JSON string)"
        required: true
        type: string
    outputs:
      statut_creation:
        description: "Statut de la crÃ©ation d'issues (success/failure)"
        value: ${{ jobs.creation-issues.outputs.statut }}
      issues_creees:
        description: "Nombre d'issues crÃ©Ã©es"
        value: ${{ jobs.creation-issues.outputs.issues_count }}

jobs:
  creation-issues:
    name: "ðŸŽ« CrÃ©ation Issues GitHub"
    runs-on: ubuntu-latest
    
    outputs:
      statut: ${{ steps.contremaÃ®tre.outputs.statut }}
      issues_count: ${{ steps.contremaÃ®tre.outputs.issues_count }}
    
    steps:
      - name: "ðŸ“ TÃ©lÃ©chargement du code source"
        uses: actions/checkout@v4

      - name: "ðŸ Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ðŸŽ« ExÃ©cution du ContremaÃ®tre CrÃ©ation Issues"
        id: contremaÃ®tre
        run: |
          echo "ðŸŽ¯ === GÃ‰NÃ‰RAL LE GREFFIER ==="
          echo "Artefacts Ã  analyser: ${{ inputs.noms_artefacts }}"
          echo ""
          
          # ExÃ©cution du script ContremaÃ®tre
          python .github/scripts/creation_issues.py \
            --artefacts '${{ inputs.noms_artefacts }}'
          
          # Capture du code de retour
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "statut=success" >> $GITHUB_OUTPUT
            echo "issues_count=1" >> $GITHUB_OUTPUT
            echo "âœ… CrÃ©ation d'issues terminÃ©e avec succÃ¨s"
          else
            echo "statut=failure" >> $GITHUB_OUTPUT
            echo "issues_count=0" >> $GITHUB_OUTPUT
            echo "âŒ CrÃ©ation d'issues Ã©chouÃ©e"
          fi

      - name: "ðŸ“Š Publication du rÃ©sumÃ© de crÃ©ation"
        if: always()
        run: |
          echo "## ðŸŽ« CrÃ©ation Issues - RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artefacts analysÃ©s :** $(echo '${{ inputs.noms_artefacts }}' | jq '. | length') artefact(s)" >> $GITHUB_STEP_SUMMARY
          echo "**Issues crÃ©Ã©es :** ${{ steps.contremaÃ®tre.outputs.issues_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Statut final :** ${{ steps.contremaÃ®tre.outputs.statut }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.contremaÃ®tre.outputs.statut }}" = "success" ]; then
            echo "âœ… **CrÃ©ation rÃ©ussie** - Issues GitHub crÃ©Ã©es pour les violations critiques" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CrÃ©ation Ã©chouÃ©e** - ProblÃ¨me lors de la crÃ©ation des issues" >> $GITHUB_STEP_SUMMARY
          fi
