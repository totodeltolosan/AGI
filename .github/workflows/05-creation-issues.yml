name: "âš–ï¸ NIVEAU 2 : GÃ©nÃ©ral Greffier - CrÃ©ation Issues"
run-name: "âš–ï¸ CrÃ©ation Issues - Collecte et RÃ©daction AutomatisÃ©e"

on:
  workflow_call:
    inputs:
      source_violations:
        description: "Source des violations Ã  traiter"
        required: true
        type: string
      labels_automatiques:
        description: "Labels Ã  appliquer automatiquement"
        required: false
        default: "audit,violation,auto-generated"
        type: string
      assignation_auto:
        description: "Assigner automatiquement"
        required: false
        default: true
        type: boolean

    outputs:
      issues_creees:
        description: "Nombre d'issues crÃ©Ã©es"
        value: ${{ jobs.poster_issues.outputs.issues_count }}
      urls_issues:
        description: "URLs des issues crÃ©Ã©es"
        value: ${{ jobs.poster_issues.outputs.issues_urls }}

jobs:
  # Ã‰TAPE 1: Collecter les violations (Niveau 4 - Ouvrier 1)
  collecteur_violations:
    name: "ğŸ“¥ Collecteur de Violations"
    uses: ./.github/workflows/04-01-issues-collecteur.yml
    with:
      source_donnees: ${{ inputs.source_violations }}
      filtre_severite: "medium,high,critical"
      format_collection: "structured_json"
      groupement_par_type: true

  # Ã‰TAPE 2: Valider collection (Niveau 5 - Qualiticien 1)
  valider_collecteur:
    name: "âœ… Valider Collection"
    needs: collecteur_violations
    uses: ./.github/workflows/05-01-issues-valid-collecteur.yml
    with:
      violations_collectees: ${{ needs.collecteur_violations.outputs.violations_structurees }}
      schema_attendu: "violations-issues-v1"
      verification_completude: true

  # Ã‰TAPE 3: RÃ©diger issues (Niveau 4 - Ouvrier 2)
  redacteur_issues:
    name: "âœï¸ RÃ©dacteur d'Issues"
    needs: [collecteur_violations, valider_collecteur]
    if: needs.valider_collecteur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-02-issues-redacteur.yml
    with:
      violations_validees: ${{ needs.collecteur_violations.outputs.violations_structurees }}
      template_titre: "ğŸš¨ Violation dÃ©tectÃ©e: {type} dans {fichier}"
      template_corps: "issue-violation-detaillee"
      inclure_contexte: true
      inclure_solution_suggeree: true

  # Ã‰TAPE 4: Valider rÃ©daction (Niveau 5 - Qualiticien 2)
  valider_redacteur:
    name: "âœ… Valider RÃ©daction"
    needs: redacteur_issues
    uses: ./.github/workflows/05-02-issues-valid-redacteur.yml
    with:
      issues_redigees: ${{ needs.redacteur_issues.outputs.issues_preparees }}
      schema_attendu: "issues-redigees-v1"
      verification_contenu: true

  # Ã‰TAPE 5: Poster les issues (Niveau 6)
  poster_issues:
    name: "ğŸ“¤ Poster Issues GitHub"
    needs: [redacteur_issues, valider_redacteur]
    if: needs.valider_redacteur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/06-04_github-poster.yml
    with:
      issues_a_creer: ${{ needs.redacteur_issues.outputs.issues_preparees }}
      labels_defaut: ${{ inputs.labels_automatiques }}
      assignation_automatique: ${{ inputs.assignation_auto }}
      mode_batch: true

  # Ã‰TAPE 6: Rapport final
  rapport_final:
    name: "ğŸ“Š Rapport de CrÃ©ation"
    needs: [poster_issues]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: "ğŸ“‹ SynthÃ¨se Issues CrÃ©Ã©es"
      run: |
        echo "ğŸ“Š RAPPORT DE CRÃ‰ATION D'ISSUES"
        echo "==============================="
        echo "Issues crÃ©Ã©es: ${{ needs.poster_issues.outputs.issues_count }}"
        echo "SuccÃ¨s: ${{ needs.poster_issues.result == 'success' }}"
        echo ""
        echo "ğŸ”— URLs des issues:"
        echo "${{ needs.poster_issues.outputs.issues_urls }}" | sed 's/,/\n/g'
