name: "ğŸ›¡ï¸ NIVEAU 2 : GÃ©nÃ©ral Gardien - Loi SÃ©curitÃ©"
run-name: "ğŸ›¡ï¸ Audit SÃ©curitÃ© - Recherche et Tri des VulnÃ©rabilitÃ©s"

on:
  workflow_call:
    inputs:
      niveau_severite:
        description: "Niveau minimum de sÃ©vÃ©ritÃ©"
        required: false
        default: "medium"
        type: string
      patterns_securite:
        description: "Patterns de sÃ©curitÃ© Ã  rechercher"
        required: false
        default: "passwords,tokens,secrets,api_keys"
        type: string
      audit_id:
        description: "Identifiant unique de l'audit"
        required: false
        type: string
        default: "audit-securite"

    outputs:
      violations_critiques:
        description: "Nombre de violations critiques"
        value: ${{ jobs.trieur.outputs.violations_critiques_count }}
      rapport_securite:
        description: "Rapport final de sÃ©curitÃ©"
        value: ${{ jobs.formater_rapport.outputs.rapport_md }}

jobs:
  # Ã‰TAPE 1: Scanner les fichiers
  scanner_fichiers:
    name: "ğŸ” Scanner Fichiers SÃ©curitÃ©"
    uses: ./.github/workflows/06-01_scanner-fichiers.yml
    with:
      dossiers_cibles: "."
      extensions_cibles: "py,js,yml,yaml,json,env"
      patterns_exclusion: '["node_modules", ".git", "__pycache__"]'

  # Ã‰TAPE 2: Chercher vulnÃ©rabilitÃ©s (Niveau 4 - Ouvrier 1)
  chercheur_vulnerabilites:
    name: "ğŸ” Chercheur de VulnÃ©rabilitÃ©s"
    needs: scanner_fichiers
    uses: ./.github/workflows/04-01-securite-chercheur.yml
    with:
      liste_fichiers: ${{ needs.scanner_fichiers.outputs.fichiers_trouves }}
      patterns_recherche: ${{ inputs.patterns_securite }}
      analyse_profonde: true
      regles_personnalisees: '["hardcoded_secrets", "sql_injection", "xss_patterns"]'

  # Ã‰TAPE 3: Valider recherche (Niveau 5 - Qualiticien 1)
  valider_chercheur:
    name: "âœ… Valider Recherche"
    needs: chercheur_vulnerabilites
    uses: ./.github/workflows/05-01-securite-valid-chercheur.yml
    with:
      resultats_recherche: ${{ needs.chercheur_vulnerabilites.outputs.vulnerabilites_brutes }}
      schema_attendu: "vulnerabilites-brutes-v1"
      validation_stricte: true

  # Ã‰TAPE 4: Trier par sÃ©vÃ©ritÃ© (Niveau 4 - Ouvrier 2)
  trieur:
    name: "ğŸ“Š Trieur de SÃ©vÃ©ritÃ©"
    needs: [chercheur_vulnerabilites, valider_chercheur]
    if: needs.valider_chercheur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-02-securite-trieur.yml
    with:
      vulnerabilites_brutes: ${{ needs.chercheur_vulnerabilites.outputs.vulnerabilites_brutes }}
      niveau_minimum: ${{ inputs.niveau_severite }}
      classification_cvss: true
      regroupement_par_type: true

  # Ã‰TAPE 5: Valider tri (Niveau 5 - Qualiticien 2)
  valider_trieur:
    name: "âœ… Valider Tri"
    needs: trieur
    uses: ./.github/workflows/05-02-securite-valid-trieur.yml
    with:
      vulnerabilites_triees: ${{ needs.trieur.outputs.vulnerabilites_classees }}
      schema_attendu: "vulnerabilites-triees-v1"
      verification_coherence: true

  # Ã‰TAPE 6: Formater rapport (Niveau 7)
  formater_rapport:
    name: "ğŸ“‹ Formater Rapport SÃ©curitÃ©"
    needs: [trieur, valider_trieur]
    if: needs.valider_trieur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/07-02_formateur-markdown.yml
    with:
      artefact_entree_json: ${{ needs.trieur.outputs.vulnerabilites_classees }}
      template_markdown: "rapport-securite-detaille"
      variables_contexte: |
        {
          "niveau_severite": "${{ inputs.niveau_severite }}",
          "audit_id": "${{ inputs.audit_id }}"
        }

  # Ã‰TAPE 7: Statut final
  statut_final:
    name: "ğŸ“¢ Statut SÃ©curitÃ©"
    needs: [trieur, valider_trieur, formater_rapport]
    if: always()
    uses: ./.github/workflows/07-03_formateur-statut.yml
    with:
      resultat: ${{ needs.trieur.outputs.violations_critiques_count == '0' && needs.valider_trieur.outputs.validation_reussie == 'true' }}
      message_succes: "âœ… Audit SÃ©curitÃ© CONFORME - Aucune vulnÃ©rabilitÃ© critique"
      message_echec: "âŒ Audit SÃ©curitÃ© NON CONFORME - ${{ needs.trieur.outputs.violations_critiques_count }} vulnÃ©rabilitÃ©s critiques"
      nom_check: "Loi SÃ©curitÃ©"
