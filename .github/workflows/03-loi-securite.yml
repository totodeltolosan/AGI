name: "🛡️ NIVEAU 2 : Général Gardien - Loi Sécurité"
run-name: "🛡️ Audit Sécurité - Recherche et Tri des Vulnérabilités"

on:
  workflow_call:
    inputs:
      niveau_severite:
        description: "Niveau minimum de sévérité"
        required: false
        default: "medium"
        type: string
      patterns_securite:
        description: "Patterns de sécurité à rechercher"
        required: false
        default: "passwords,tokens,secrets,api_keys"
        type: string
      audit_id:
        description: "Identifiant unique de l'audit"
        required: false
        type: string
        default: "audit-securite"

    outputs:
      violations_critiques:
        description: "Nombre de violations critiques"
        value: ${{ jobs.trieur.outputs.violations_critiques_count }}
      rapport_securite:
        description: "Rapport final de sécurité"
        value: ${{ jobs.formater_rapport.outputs.rapport_md }}

jobs:
  # ÉTAPE 1: Scanner les fichiers
  scanner_fichiers:
    name: "🔍 Scanner Fichiers Sécurité"
    uses: ./.github/workflows/06-01_scanner-fichiers.yml
    with:
      dossiers_cibles: "."
      extensions_cibles: "py,js,yml,yaml,json,env"
      patterns_exclusion: '["node_modules", ".git", "__pycache__"]'

  # ÉTAPE 2: Chercher vulnérabilités (Niveau 4 - Ouvrier 1)
  chercheur_vulnerabilites:
    name: "🔎 Chercheur de Vulnérabilités"
    needs: scanner_fichiers
    uses: ./.github/workflows/04-01-securite-chercheur.yml
    with:
      liste_fichiers: ${{ needs.scanner_fichiers.outputs.fichiers_trouves }}
      patterns_recherche: ${{ inputs.patterns_securite }}
      analyse_profonde: true
      regles_personnalisees: '["hardcoded_secrets", "sql_injection", "xss_patterns"]'

  # ÉTAPE 3: Valider recherche (Niveau 5 - Qualiticien 1)
  valider_chercheur:
    name: "✅ Valider Recherche"
    needs: chercheur_vulnerabilites
    uses: ./.github/workflows/05-01-securite-valid-chercheur.yml
    with:
      resultats_recherche: ${{ needs.chercheur_vulnerabilites.outputs.vulnerabilites_brutes }}
      schema_attendu: "vulnerabilites-brutes-v1"
      validation_stricte: true

  # ÉTAPE 4: Trier par sévérité (Niveau 4 - Ouvrier 2)
  trieur:
    name: "📊 Trieur de Sévérité"
    needs: [chercheur_vulnerabilites, valider_chercheur]
    if: needs.valider_chercheur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/04-02-securite-trieur.yml
    with:
      vulnerabilites_brutes: ${{ needs.chercheur_vulnerabilites.outputs.vulnerabilites_brutes }}
      niveau_minimum: ${{ inputs.niveau_severite }}
      classification_cvss: true
      regroupement_par_type: true

  # ÉTAPE 5: Valider tri (Niveau 5 - Qualiticien 2)
  valider_trieur:
    name: "✅ Valider Tri"
    needs: trieur
    uses: ./.github/workflows/05-02-securite-valid-trieur.yml
    with:
      vulnerabilites_triees: ${{ needs.trieur.outputs.vulnerabilites_classees }}
      schema_attendu: "vulnerabilites-triees-v1"
      verification_coherence: true

  # ÉTAPE 6: Formater rapport (Niveau 7)
  formater_rapport:
    name: "📋 Formater Rapport Sécurité"
    needs: [trieur, valider_trieur]
    if: needs.valider_trieur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/07-02_formateur-markdown.yml
    with:
      artefact_entree_json: ${{ needs.trieur.outputs.vulnerabilites_classees }}
      template_markdown: "rapport-securite-detaille"
      variables_contexte: |
        {
          "niveau_severite": "${{ inputs.niveau_severite }}",
          "audit_id": "${{ inputs.audit_id }}"
        }

  # ÉTAPE 7: Statut final
  statut_final:
    name: "📢 Statut Sécurité"
    needs: [trieur, valider_trieur, formater_rapport]
    if: always()
    uses: ./.github/workflows/07-03_formateur-statut.yml
    with:
      resultat: ${{ needs.trieur.outputs.violations_critiques_count == '0' && needs.valider_trieur.outputs.validation_reussie == 'true' }}
      message_succes: "✅ Audit Sécurité CONFORME - Aucune vulnérabilité critique"
      message_echec: "❌ Audit Sécurité NON CONFORME - ${{ needs.trieur.outputs.violations_critiques_count }} vulnérabilités critiques"
      nom_check: "Loi Sécurité"
