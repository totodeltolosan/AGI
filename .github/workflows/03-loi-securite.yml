name: "ðŸ›¡ï¸ GÃ©nÃ©ral Le Gardien - Loi SÃ©curitÃ©"

on:
  workflow_call:
    inputs:
      regles_securite:
        description: "RÃ¨gles de sÃ©curitÃ© Ã  appliquer (JSON string)"
        required: true
        type: string
    outputs:
      statut_audit:
        description: "Statut de l'audit sÃ©curitÃ© (success/failure)"
        value: ${{ jobs.audit-securite.outputs.statut }}
      rapport_final:
        description: "Nom de l'artefact du rapport final"
        value: "rapport-securite"

jobs:
  audit-securite:
    name: "ðŸ›¡ï¸ Audit Complet Loi SÃ©curitÃ©"
    runs-on: ubuntu-latest
    
    outputs:
      statut: ${{ steps.contremaÃ®tre.outputs.statut }}
    
    steps:
      - name: "ðŸ“ TÃ©lÃ©chargement du code source"
        uses: actions/checkout@v4

      - name: "ðŸ Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ðŸ›¡ï¸ ExÃ©cution du ContremaÃ®tre Audit SÃ©curitÃ©"
        id: contremaÃ®tre
        run: |
          echo "ðŸŽ¯ === GÃ‰NÃ‰RAL LE GARDIEN ==="
          echo "RÃ¨gles de sÃ©curitÃ©: $(echo '${{ inputs.regles_securite }}' | jq '. | length') rÃ¨gle(s)"
          echo ""
          
          # ExÃ©cution du script ContremaÃ®tre
          python .github/scripts/audit_securite.py \
            --regles '${{ inputs.regles_securite }}'
          
          # Capture du code de retour
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "statut=success" >> $GITHUB_OUTPUT
            echo "âœ… Audit sÃ©curitÃ© terminÃ© avec succÃ¨s"
          else
            echo "statut=failure" >> $GITHUB_OUTPUT
            echo "âŒ Audit sÃ©curitÃ© Ã©chouÃ©"
          fi

      - name: "ðŸ“Š Publication du rÃ©sumÃ© d'audit"
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Audit Loi SÃ©curitÃ© - RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**RÃ¨gles appliquÃ©es :** $(echo '${{ inputs.regles_securite }}' | jq '. | length') rÃ¨gle(s)" >> $GITHUB_STEP_SUMMARY
          echo "**Statut final :** ${{ steps.contremaÃ®tre.outputs.statut }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.contremaÃ®tre.outputs.statut }}" = "success" ]; then
            echo "âœ… **Audit rÃ©ussi** - Aucune violation critique dÃ©tectÃ©e" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Audit Ã©chouÃ©** - Des violations de sÃ©curitÃ© dÃ©tectÃ©es" >> $GITHUB_STEP_SUMMARY
          fi
