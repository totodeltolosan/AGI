name: "🗺️ NIVEAU 2 : Général Cartographe - Contrôle PlantUML"
run-name: "🗺️ Contrôle PlantUML - Vérification Synchronisation"

on:
  workflow_call:
    inputs:
      chemin_diagramme:
        description: "Chemin vers le diagramme PlantUML"
        required: true
        type: string
      dossiers_critiques:
        description: "Dossiers critiques à surveiller"
        required: true
        type: string

    outputs:
      mise_a_jour_requise:
        description: "Mise à jour du diagramme requise"
        value: ${{ jobs.comparateur.outputs.mise_a_jour_requise }}
      rapport_comparaison:
        description: "Rapport de comparaison"
        value: ${{ jobs.formater_statut.outputs.message_final }}

jobs:
  # ÉTAPE 1: Date du diagramme (Niveau 6)
  date_diagramme:
    name: "📅 Date Diagramme"
    uses: ./.github/workflows/06-06_git-historien.yml
    with:
      chemin_fichier_ou_dossier: ${{ inputs.chemin_diagramme }}
      format_timestamp: "ISO"

  # ÉTAPE 2: Date du code (Niveau 6)
  date_code:
    name: "📅 Date Code"
    uses: ./.github/workflows/06-06_git-historien.yml
    with:
      chemin_fichier_ou_dossier: ${{ inputs.dossiers_critiques }}
      format_timestamp: "ISO"
      mode_recursif: true

  # ÉTAPE 3: Comparer dates (Niveau 4 - Ouvrier)
  comparateur:
    name: "⚖️ Comparateur de Dates"
    needs: [date_diagramme, date_code]
    uses: ./.github/workflows/04-01-planuml-comparateur.yml
    with:
      date_diagramme: ${{ needs.date_diagramme.outputs.timestamp }}
      date_code: ${{ needs.date_code.outputs.timestamp }}
      tolerance_heures: 1

  # ÉTAPE 4: Valider comparaison (Niveau 5 - Qualiticien)
  valider_comparateur:
    name: "✅ Valider Comparaison"
    needs: comparateur
    uses: ./.github/workflows/05-01-planuml-valid-comparateur.yml
    with:
      resultat_comparaison: ${{ needs.comparateur.outputs.resultat_json }}
      schema_attendu: "comparaison-planuml-v1"

  # ÉTAPE 5: Formater statut final (Niveau 7)
  formater_statut:
    name: "📢 Statut PlantUML"
    needs: [comparateur, valider_comparateur]
    if: needs.valider_comparateur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/07-03_formateur-statut.yml
    with:
      resultat: ${{ needs.comparateur.outputs.mise_a_jour_requise != 'true' }}
      message_succes: "✅ Diagramme PlantUML synchronisé"
      message_echec: "⚠️ Diagramme PlantUML nécessite une mise à jour"
      nom_check: "Contrôle PlantUML"
      details_url: ${{ inputs.chemin_diagramme }}
