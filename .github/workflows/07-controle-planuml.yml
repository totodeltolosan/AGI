name: "ðŸ“ GÃ©nÃ©ral Le Cartographe - ContrÃ´le PlantUML"

on:
  workflow_call:
    inputs:
      chemin_diagramme:
        description: "Chemin vers le fichier diagramme PlantUML"
        required: true
        type: string
      dossiers_critiques:
        description: "Liste des dossiers critiques Ã  surveiller (JSON string)"
        required: true
        type: string
    outputs:
      statut_controle:
        description: "Statut du contrÃ´le PlantUML (success/warning)"
        value: ${{ jobs.controle-planuml.outputs.statut }}
      mise_a_jour_requise:
        description: "Indique si une mise Ã  jour est requise"
        value: ${{ jobs.controle-planuml.outputs.mise_a_jour }}

jobs:
  controle-planuml:
    name: "ðŸ“ ContrÃ´le Synchronisation PlantUML"
    runs-on: ubuntu-latest
    
    outputs:
      statut: ${{ steps.contremaÃ®tre.outputs.statut }}
      mise_a_jour: ${{ steps.contremaÃ®tre.outputs.mise_a_jour }}
    
    steps:
      - name: "ðŸ“ TÃ©lÃ©chargement du code source"
        uses: actions/checkout@v4

      - name: "ðŸ Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ðŸ“ ExÃ©cution du ContremaÃ®tre Audit PlantUML"
        id: contremaÃ®tre
        run: |
          echo "ðŸŽ¯ === GÃ‰NÃ‰RAL LE CARTOGRAPHE ==="
          echo "Diagramme: ${{ inputs.chemin_diagramme }}"
          echo "Dossiers critiques: ${{ inputs.dossiers_critiques }}"
          echo ""
          
          # ExÃ©cution du script ContremaÃ®tre
          python .github/scripts/audit_planuml.py \
            --diagramme "${{ inputs.chemin_diagramme }}" \
            --dossiers-critiques '${{ inputs.dossiers_critiques }}'
          
          # Capture du code de retour
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "statut=success" >> $GITHUB_OUTPUT
            echo "mise_a_jour=false" >> $GITHUB_OUTPUT
            echo "âœ… ContrÃ´le PlantUML terminÃ© avec succÃ¨s"
          else
            echo "statut=warning" >> $GITHUB_OUTPUT
            echo "mise_a_jour=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Mise Ã  jour du diagramme recommandÃ©e"
          fi

      - name: "ðŸ“Š Publication du rÃ©sumÃ© de contrÃ´le"
        if: always()
        run: |
          echo "## ðŸ“ ContrÃ´le PlantUML - RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Diagramme analysÃ© :** ${{ inputs.chemin_diagramme }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dossiers surveillÃ©s :** $(echo '${{ inputs.dossiers_critiques }}' | jq '. | length') dossier(s)" >> $GITHUB_STEP_SUMMARY
          echo "**Statut final :** ${{ steps.contremaÃ®tre.outputs.statut }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.contremaÃ®tre.outputs.statut }}" = "success" ]; then
            echo "âœ… **Diagramme synchronisÃ©** - Aucune mise Ã  jour requise" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Mise Ã  jour recommandÃ©e** - Le diagramme semble obsolÃ¨te" >> $GITHUB_STEP_SUMMARY
          fi
