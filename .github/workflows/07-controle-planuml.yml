name: "ğŸ—ºï¸ NIVEAU 2 : GÃ©nÃ©ral Cartographe - ContrÃ´le PlantUML"
run-name: "ğŸ—ºï¸ ContrÃ´le PlantUML - VÃ©rification Synchronisation"

on:
  workflow_call:
    inputs:
      chemin_diagramme:
        description: "Chemin vers le diagramme PlantUML"
        required: true
        type: string
      dossiers_critiques:
        description: "Dossiers critiques Ã  surveiller"
        required: true
        type: string

    outputs:
      mise_a_jour_requise:
        description: "Mise Ã  jour du diagramme requise"
        value: ${{ jobs.comparateur.outputs.mise_a_jour_requise }}
      rapport_comparaison:
        description: "Rapport de comparaison"
        value: ${{ jobs.formater_statut.outputs.message_final }}

jobs:
  # Ã‰TAPE 1: Date du diagramme (Niveau 6)
  date_diagramme:
    name: "ğŸ“… Date Diagramme"
    uses: ./.github/workflows/06-06_git-historien.yml
    with:
      chemin_fichier_ou_dossier: ${{ inputs.chemin_diagramme }}
      format_timestamp: "ISO"

  # Ã‰TAPE 2: Date du code (Niveau 6)
  date_code:
    name: "ğŸ“… Date Code"
    uses: ./.github/workflows/06-06_git-historien.yml
    with:
      chemin_fichier_ou_dossier: ${{ inputs.dossiers_critiques }}
      format_timestamp: "ISO"
      mode_recursif: true

  # Ã‰TAPE 3: Comparer dates (Niveau 4 - Ouvrier)
  comparateur:
    name: "âš–ï¸ Comparateur de Dates"
    needs: [date_diagramme, date_code]
    uses: ./.github/workflows/04-01-planuml-comparateur.yml
    with:
      date_diagramme: ${{ needs.date_diagramme.outputs.timestamp }}
      date_code: ${{ needs.date_code.outputs.timestamp }}
      tolerance_heures: 1

  # Ã‰TAPE 4: Valider comparaison (Niveau 5 - Qualiticien)
  valider_comparateur:
    name: "âœ… Valider Comparaison"
    needs: comparateur
    uses: ./.github/workflows/05-01-planuml-valid-comparateur.yml
    with:
      resultat_comparaison: ${{ needs.comparateur.outputs.resultat_json }}
      schema_attendu: "comparaison-planuml-v1"

  # Ã‰TAPE 5: Formater statut final (Niveau 7)
  formater_statut:
    name: "ğŸ“¢ Statut PlantUML"
    needs: [comparateur, valider_comparateur]
    if: needs.valider_comparateur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/07-03_formateur-statut.yml
    with:
      resultat: ${{ needs.comparateur.outputs.mise_a_jour_requise != 'true' }}
      message_succes: "âœ… Diagramme PlantUML synchronisÃ©"
      message_echec: "âš ï¸ Diagramme PlantUML nÃ©cessite une mise Ã  jour"
      nom_check: "ContrÃ´le PlantUML"
      details_url: ${{ inputs.chemin_diagramme }}
