name: "Nettoyeur : Formateur Markdown"

on:
  workflow_call:
    inputs:
      artefact_entree_json:
        description: "Nom de l'artefact JSON Ã  consommer"
        required: true
        type: string
      template_markdown:
        description: "Template Markdown avec placeholders ({{variable}}, {{#if condition}}, {{#each array}})"
        required: true
        type: string
      nom_fichier_sortie:
        description: "Nom du fichier Markdown Ã  crÃ©er"
        required: false
        default: "rapport.md"
        type: string
    outputs:
      markdown_file_path:
        description: "Chemin vers le fichier Markdown gÃ©nÃ©rÃ©"
        value: ${{ jobs.format_markdown.outputs.md_path }}

jobs:
  format_markdown:
    name: "GÃ©nÃ©ration rapport Markdown"
    runs-on: ubuntu-latest
    outputs:
      md_path: ${{ steps.format.outputs.md_path }}
    
    steps:
      - name: "Checkout du code"
        uses: actions/checkout@v4
      
      - name: "Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: "Installation des dÃ©pendances Python"
        run: |
          python -m pip install --upgrade pip
          # Utilise seulement la stdlib Python
      
      - name: "TÃ©lÃ©chargement de l'artefact JSON d'entrÃ©e"
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artefact_entree_json }}
          path: ./input/
      
      - name: "PrÃ©paration du template Markdown"
        run: |
          echo '${{ inputs.template_markdown }}' > template.md
          echo "ðŸ“ Template prÃ©parÃ©"
      
      - name: "ExÃ©cution du formateur Markdown"
        id: format
        run: |
          python .github/scripts/nettoyeur_format_markdown.py \
            --artefact-entree-json "./input/${{ inputs.artefact_entree_json }}" \
            --template-markdown "template.md" \
            --nom-fichier-sortie "${{ inputs.nom_fichier_sortie }}"
          
          echo "md_path=${{ inputs.nom_fichier_sortie }}" >> $GITHUB_OUTPUT
          echo "âœ… Formatage Markdown terminÃ© avec succÃ¨s"
      
      - name: "Upload de l'artefact Markdown"
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.nom_fichier_sortie }}
          path: ${{ inputs.nom_fichier_sortie }}
          retention-days: 30
      
      - name: "Validation et aperÃ§u du rapport"
        run: |
          if [ -f "${{ inputs.nom_fichier_sortie }}" ]; then
            echo "ðŸ“„ Fichier Markdown crÃ©Ã© : ${{ inputs.nom_fichier_sortie }}"
            echo "ðŸ“Š Taille : $(stat -c%s "${{ inputs.nom_fichier_sortie }}") octets"
            echo "ðŸ“‹ PremiÃ¨res lignes du rapport :"
            echo "--- DÃ‰BUT APERÃ‡U ---"
            head -10 "${{ inputs.nom_fichier_sortie }}" || true
            echo "--- FIN APERÃ‡U ---"
            echo "ðŸ“ˆ Total lignes : $(wc -l < "${{ inputs.nom_fichier_sortie }}")"
          else
            echo "âŒ ERREUR: Fichier Markdown non crÃ©Ã©"
            exit 1
          fi
