name: "ğŸ” Le StratÃ¨ge - Analyseur de Progression de Fusion"

on:
  schedule:
    - cron: '0 2 * * 1'  # Tous les lundis Ã  2h du matin
  workflow_dispatch:      # Permet l'exÃ©cution manuelle
  push:
    paths:
      - 'eve/**'         # Se dÃ©clenche aussi quand EVE est modifiÃ©

env:
  PYTHON_VERSION: "3.11"
  EVE_PATH: "eve"
  REPORT_PATH: "reports"

jobs:
  fusion_progress_analysis:
    runs-on: ubuntu-latest
    name: "ğŸ“Š Analyse StratÃ©gique EVE"

    steps:
    - name: "ğŸ”„ Checkout Repository"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: "ğŸ“¦ Install Dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install radon           # Pour complexitÃ© cyclomatique
        pip install pygments       # Pour coloration syntaxique
        pip install tabulate       # Pour tableaux formatÃ©s
        pip install matplotlib     # Pour graphiques de progression
        pip install seaborn        # Pour visualisations avancÃ©es

    - name: "ğŸ“ Create Reports Directory"
      run: |
        mkdir -p ${{ env.REPORT_PATH }}
        mkdir -p ${{ env.REPORT_PATH }}/assets

    - name: "ğŸ” Execute Strategic Analysis"
      run: |
        python .github/scripts/fusion_analyzer.py
      env:
        EVE_ROOT: ${{ env.EVE_PATH }}
        REPORT_DIR: ${{ env.REPORT_PATH }}

    - name: "ğŸ“ˆ Generate Progress Visualizations"
      run: |
        python .github/scripts/progress_visualizer.py
      env:
        REPORT_DIR: ${{ env.REPORT_PATH }}

    - name: "ğŸ“‹ Archive Reports"
      uses: actions/upload-artifact@v3
      with:
        name: fusion-progress-report-${{ github.run_number }}
        path: |
          ${{ env.REPORT_PATH }}/
          !${{ env.REPORT_PATH }}/**/*.pyc

    - name: "ğŸ“¤ Commit Progress Report"
      run: |
        git config --global user.name 'Le StratÃ¨ge Bot'
        git config --global user.email 'strategist@agi-project.dev'

        # Ajouter le rapport gÃ©nÃ©rÃ©
        git add ${{ env.REPORT_PATH }}/FUSION_PROGRESS_REPORT.md
        git add ${{ env.REPORT_PATH }}/assets/

        # Commit avec timestamp
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        git commit -m "ğŸ” Rapport stratÃ©gique EVE - $TIMESTAMP" || echo "Aucun changement dÃ©tectÃ©"

        # Push uniquement si on est sur la branche principale
        if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
          git push
        fi

    - name: "ğŸ’¬ Create Issue for Strategic Review"
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = '${{ env.REPORT_PATH }}/FUSION_PROGRESS_REPORT.md';

          try {
            const reportContent = fs.readFileSync(path, 'utf8');
            const timestamp = new Date().toISOString().split('T')[0];

            const issueBody = `
          ## ğŸ” Rapport StratÃ©gique EVE - ${timestamp}

          **Le StratÃ¨ge** a terminÃ© son analyse hebdomadaire de l'Ã©cosystÃ¨me EVE.

          ### ğŸ“Š Rapport Complet
          Le rapport dÃ©taillÃ© est disponible dans: \`${{ env.REPORT_PATH }}/FUSION_PROGRESS_REPORT.md\`

          ### ğŸ¯ Question StratÃ©gique
          ${reportContent.split('## ğŸ¤” Question StratÃ©gique')[1] || 'Voir le rapport complet pour la question stratÃ©gique.'}

          ### ğŸ“ˆ Artefacts GÃ©nÃ©rÃ©s
          - Rapport de progression: \`FUSION_PROGRESS_REPORT.md\`
          - Graphiques de conformitÃ©: \`assets/compliance_charts.png\`
          - Carte de complexitÃ©: \`assets/complexity_heatmap.png\`
          - DonnÃ©es brutes: \`assets/fusion_data.json\`

          **Action requise:** Examiner le rapport et dÃ©cider de la stratÃ©gie pour la semaine.

          ---
          *GÃ©nÃ©rÃ© automatiquement par Le StratÃ¨ge ğŸ¤–*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ” Analyse StratÃ©gique EVE - ${timestamp}`,
              body: issueBody,
              labels: ['strategy', 'fusion-progress', 'weekly-report']
            });
          } catch (error) {
            console.log('Erreur lors de la crÃ©ation de l\'issue:', error.message);
          }

  notify_completion:
    needs: fusion_progress_analysis
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: "ğŸ“¬ Notification Completion"
      run: |
        echo "ğŸ¯ Mission accomplie: Analyse stratÃ©gique EVE terminÃ©e"
        echo "ğŸ“Š Rapport disponible dans: ${{ env.REPORT_PATH }}/FUSION_PROGRESS_REPORT.md"
        echo "ğŸ¤” Question stratÃ©gique gÃ©nÃ©rÃ©e pour l'architecte"
        echo "ğŸ“ˆ Visualisations crÃ©Ã©es pour aide Ã  la dÃ©cision"
