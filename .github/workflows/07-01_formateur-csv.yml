name: "Nettoyeur : Formateur CSV"

on:
  workflow_call:
    inputs:
      artefact_entree_json:
        description: "Nom de l'artefact JSON Ã  consommer"
        required: true
        type: string
      nom_fichier_sortie_csv:
        description: "Nom du fichier CSV Ã  crÃ©er"
        required: true
        type: string
      colonnes:
        description: "JSON string dÃ©finissant les colonnes Ã  extraire (ex: [\"nom\", \"valeur\", \"stats.total\"])"
        required: true
        type: string
    outputs:
      csv_file_path:
        description: "Chemin vers le fichier CSV gÃ©nÃ©rÃ©"
        value: ${{ jobs.format_csv.outputs.csv_path }}

jobs:
  format_csv:
    name: "Transformation JSON vers CSV"
    runs-on: ubuntu-latest
    outputs:
      csv_path: ${{ steps.format.outputs.csv_path }}
    
    steps:
      - name: "Checkout du code"
        uses: actions/checkout@v4
      
      - name: "Configuration Python 3.11"
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: "Installation des dÃ©pendances Python"
        run: |
          python -m pip install --upgrade pip
          # Aucune dÃ©pendance externe nÃ©cessaire - utilise seulement la stdlib
      
      - name: "TÃ©lÃ©chargement de l'artefact JSON d'entrÃ©e"
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.artefact_entree_json }}
          path: ./input/
      
      - name: "ExÃ©cution du formateur CSV"
        id: format
        run: |
          python .github/scripts/nettoyeur_format_csv.py \
            --artefact-entree-json "./input/${{ inputs.artefact_entree_json }}" \
            --nom-fichier-sortie-csv "${{ inputs.nom_fichier_sortie_csv }}" \
            --colonnes '${{ inputs.colonnes }}'
          
          echo "csv_path=${{ inputs.nom_fichier_sortie_csv }}" >> $GITHUB_OUTPUT
          echo "âœ… Formatage CSV terminÃ© avec succÃ¨s"
      
      - name: "Upload de l'artefact CSV"
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.nom_fichier_sortie_csv }}
          path: ${{ inputs.nom_fichier_sortie_csv }}
          retention-days: 30
      
      - name: "Validation post-gÃ©nÃ©ration"
        run: |
          if [ -f "${{ inputs.nom_fichier_sortie_csv }}" ]; then
            echo "ğŸ“Š Fichier CSV crÃ©Ã© : ${{ inputs.nom_fichier_sortie_csv }}"
            echo "ğŸ“„ Taille : $(stat -c%s "${{ inputs.nom_fichier_sortie_csv }}") octets"
            echo "ğŸ“‹ PremiÃ¨res lignes :"
            head -3 "${{ inputs.nom_fichier_sortie_csv }}" || true
          else
            echo "âŒ ERREUR: Fichier CSV non crÃ©Ã©"
            exit 1
          fi
