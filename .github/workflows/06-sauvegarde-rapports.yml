name: "🗃️ NIVEAU 2 : Général Archiviste Chef - Sauvegarde Rapports"
run-name: "🗃️ Sauvegarde - Collection et Archivage des Rapports"

on:
  workflow_call:
    inputs:
      pattern_artefacts:
        description: "Pattern des artefacts à collecter"
        required: false
        default: "*rapport*,*audit*,*synthese*"
        type: string
      nom_archive:
        description: "Nom de l'archive finale"
        required: false
        default: "rapports-audit-complets"
        type: string
      retention_jours:
        description: "Durée de rétention en jours"
        required: false
        default: 90
        type: number

    outputs:
      archive_url:
        description: "URL de l'archive créée"
        value: ${{ jobs.archiver.outputs.archive_url }}
      fichiers_archives:
        description: "Liste des fichiers archivés"
        value: ${{ jobs.archiver.outputs.fichiers_liste }}

jobs:
  # ÉTAPE 1: Collecter les rapports (Niveau 4 - Ouvrier)
  collecteur_rapports:
    name: "📥 Collecteur de Rapports"
    uses: ./.github/workflows/04-01-sauvegarde-collecteur.yml
    with:
      patterns_recherche: ${{ inputs.pattern_artefacts }}
      dossiers_cibles: "./rapports,./artifacts"
      collecte_recursive: true
      verification_integrite: true

  # ÉTAPE 2: Valider collection (Niveau 5 - Qualiticien)
  valider_collecteur:
    name: "✅ Valider Collection"
    needs: collecteur_rapports
    uses: ./.github/workflows/05-01-sauvegarde-valid-collecteur.yml
    with:
      fichiers_collectes: ${{ needs.collecteur_rapports.outputs.fichiers_trouves }}
      verification_completude: true
      taille_minimale: "1KB"

  # ÉTAPE 3: Archiver (Niveau 6)
  archiver:
    name: "🗜️ Créer Archive"
    needs: [collecteur_rapports, valider_collecteur]
    if: needs.valider_collecteur.outputs.validation_reussie == 'true'
    uses: ./.github/workflows/06-05_archiveur-zip.yml
    with:
      fichiers_a_zipper: ${{ needs.collecteur_rapports.outputs.fichiers_trouves }}
      nom_archive: ${{ inputs.nom_archive }}-${{ github.run_id }}
      compression_niveau: 9
      inclure_metadata: true

  # ÉTAPE 4: Upload final
  upload_final:
    name: "☁️ Upload Archive"
    needs: archiver
    runs-on: ubuntu-latest

    steps:
    - name: "📤 Upload Archive Complète"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.nom_archive }}-final
        path: ${{ needs.archiver.outputs.archive_path }}
        retention-days: ${{ inputs.retention_jours }}
        compression-level: 9
