name: "Travailleur : Git Historien"

on:
  workflow_call:
    inputs:
      chemin_fichier_ou_dossier:
        description: "Chemin vers le fichier ou dossier Ã  analyser"
        required: true
        type: string
      format_sortie:
        description: "Format de la date retournÃ©e (timestamp/iso/human)"
        required: false
        default: "iso"
        type: string
      operation:
        description: "Type d'opÃ©ration (last_commit/first_commit/all_commits)"
        required: false
        default: "last_commit"
        type: string
      generer_artefact:
        description: "GÃ©nÃ©rer un artefact JSON avec les dÃ©tails complets"
        required: false
        default: true
        type: boolean
    outputs:
      date_commit:
        description: "Date du commit (format selon format_sortie)"
        value: ${{ jobs.git_history.outputs.date_output }}
      commit_hash:
        description: "Hash du commit principal trouvÃ©"
        value: ${{ jobs.git_history.outputs.commit_hash }}
      commit_author:
        description: "Auteur du commit principal"
        value: ${{ jobs.git_history.outputs.commit_author }}
      total_commits:
        description: "Nombre total de commits trouvÃ©s"
        value: ${{ jobs.git_history.outputs.total_commits }}

jobs:
  git_history:
    name: "Analyse historique Git"
    runs-on: ubuntu-latest
    outputs:
      date_output: ${{ steps.git_analyze.outputs.date_output }}
      commit_hash: ${{ steps.git_analyze.outputs.commit_hash }}
      commit_author: ${{ steps.git_analyze.outputs.commit_author }}
      total_commits: ${{ steps.git_analyze.outputs.total_commits }}
    
    steps:
      - name: "Checkout du code avec historique complet"
        uses: actions/checkout@v4
        with:
          # RÃ©cupÃ©rer l'historique complet pour l'analyse Git
          fetch-depth: 0
      
      - name: "Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: "Installation des dÃ©pendances Python"
        run: |
          python -m pip install --upgrade pip
          # Utilise seulement la stdlib Python
      
      - name: "Validation des paramÃ¨tres d'entrÃ©e"
        run: |
          echo "ğŸ” Validation des paramÃ¨tres Git :"
          
          # Validation du chemin
          if [ -z "${{ inputs.chemin_fichier_ou_dossier }}" ]; then
            echo "âŒ ERREUR: Chemin requis"
            exit 1
          fi
          
          if [ ! -e "${{ inputs.chemin_fichier_ou_dossier }}" ]; then
            echo "âŒ ERREUR: Chemin introuvable : ${{ inputs.chemin_fichier_ou_dossier }}"
            echo "ğŸ“ Contenu du rÃ©pertoire actuel :"
            ls -la
            exit 1
          fi
          echo "âœ… Chemin validÃ© : ${{ inputs.chemin_fichier_ou_dossier }}"
          
          # Validation du format de sortie
          case "${{ inputs.format_sortie }}" in
            timestamp|iso|human)
              echo "âœ… Format sortie : ${{ inputs.format_sortie }}"
              ;;
            *)
              echo "âŒ ERREUR: Format sortie invalide : ${{ inputs.format_sortie }}"
              echo "Valeurs acceptÃ©es: timestamp, iso, human"
              exit 1
              ;;
          esac
          
          # Validation de l'opÃ©ration
          case "${{ inputs.operation }}" in
            last_commit|first_commit|all_commits)
              echo "âœ… OpÃ©ration : ${{ inputs.operation }}"
              ;;
            *)
              echo "âŒ ERREUR: OpÃ©ration invalide : ${{ inputs.operation }}"
              echo "Valeurs acceptÃ©es: last_commit, first_commit, all_commits"
              exit 1
              ;;
          esac
      
      - name: "VÃ©rification de l'environnement Git"
        run: |
          echo "ğŸ“Š Ã‰tat de l'environnement Git :"
          echo "   â€¢ Version Git : $(git --version)"
          echo "   â€¢ Repository : $(git rev-parse --show-toplevel 2>/dev/null || echo 'Non disponible')"
          echo "   â€¢ Branche actuelle : $(git branch --show-current 2>/dev/null || echo 'Non disponible')"
          echo "   â€¢ Dernier commit global : $(git log -1 --format='%h - %s' 2>/dev/null || echo 'Non disponible')"
          
          # VÃ©rifier l'historique pour le chemin spÃ©cifique
          echo "ğŸ” VÃ©rification de l'historique pour : ${{ inputs.chemin_fichier_ou_dossier }}"
          commit_count=$(git log --oneline -- "${{ inputs.chemin_fichier_ou_dossier }}" | wc -l)
          echo "   â€¢ Commits trouvÃ©s : $commit_count"
          
          if [ "$commit_count" -eq 0 ]; then
            echo "âš ï¸  Aucun commit trouvÃ© pour ce chemin"
            echo "   â€¢ Le fichier/dossier peut Ãªtre nouveau ou non suivi par Git"
            echo "   â€¢ Statut Git du chemin :"
            git status --porcelain "${{ inputs.chemin_fichier_ou_dossier }}" || echo "     Non dans le statut Git"
          fi
      
      - name: "ExÃ©cution de l'historien Git"
        id: git_analyze
        run: |
          artefact_name="git-historique-$(date +%Y%m%d-%H%M%S).json"
          
          python .github/scripts/travailleur_git_historien.py \
            --chemin-fichier-ou-dossier "${{ inputs.chemin_fichier_ou_dossier }}" \
            --format-sortie "${{ inputs.format_sortie }}" \
            --operation "${{ inputs.operation }}" \
            --sortie "$artefact_name"
          
          # Extraction des informations pour les outputs
          if [ -f "$artefact_name" ]; then
            echo "artefact_file=$artefact_name" >> $GITHUB_OUTPUT
            
            # Parse des rÃ©sultats JSON pour extraire les informations clÃ©s
            python -c "import json; import sys; try:; with open('$artefact_name', 'r') as f:; data = json.load(f); ; git_history = data.get('git_history'); if git_history:; if git_history['type'] in ['last_commit', 'first_commit']:; print(f'date_output={data[\\"formatted_output\\"]}'); print(f'commit_hash={git_history[\\"commit_hash\\"][:8]}'); print(f'commit_author={git_history[\\"author\\"]}'); print(f'total_commits=1'); elif git_history['type'] == 'all_commits':; print(f'date_output={data[\\"formatted_output\\"]}'); commits = git_history.get('commits', []); if commits:; print(f'commit_hash={commits[0][\\"commit_hash\\"][:8]}'); print(f'commit_author={commits[0][\\"author\\"]}'); else:; print('commit_hash='); print('commit_author='); print(f'total_commits={git_history[\\"total_commits\\"]}'); else:; print('date_output='); print('commit_hash='); print('commit_author='); print('total_commits=0'); except Exception as e:; print(f'Erreur extraction outputs: {e}', file=sys.stderr); print('date_output='); print('commit_hash='); print('commit_author='); print('total_commits=0')" $GITHUB_OUTPUT
          else
            echo "date_output=" >> $GITHUB_OUTPUT
            echo "commit_hash=" >> $GITHUB_OUTPUT
            echo "commit_author=" >> $GITHUB_OUTPUT
            echo "total_commits=0" >> $GITHUB_OUTPUT
            echo "artefact_file=" >> $GITHUB_OUTPUT
            echo "âš ï¸  Pas d'artefact gÃ©nÃ©rÃ©"
          fi
      
      - name: "Upload de l'artefact historique Git"
        if: inputs.generer_artefact && steps.git_analyze.outputs.artefact_file
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.git_analyze.outputs.artefact_file }}
          path: ${{ steps.git_analyze.outputs.artefact_file }}
          retention-days: 30
      
      - name: "Rapport d'analyse Git et validation"
        run: |
          echo "ğŸ“Š RÃ©sumÃ© de l'analyse Git :"
          echo "   â€¢ Chemin analysÃ© : ${{ inputs.chemin_fichier_ou_dossier }}"
          echo "   â€¢ OpÃ©ration : ${{ inputs.operation }}"
          echo "   â€¢ Format sortie : ${{ inputs.format_sortie }}"
          
          if [ -n "${{ steps.git_analyze.outputs.date_output }}" ]; then
            echo "   â€¢ Date trouvÃ©e : ${{ steps.git_analyze.outputs.date_output }}"
            echo "   â€¢ Commit : ${{ steps.git_analyze.outputs.commit_hash }}"
            echo "   â€¢ Auteur : ${{ steps.git_analyze.outputs.commit_author }}"
            echo "   â€¢ Total commits : ${{ steps.git_analyze.outputs.total_commits }}"
            
            # Affichage dÃ©taillÃ© selon l'opÃ©ration
            case "${{ inputs.operation }}" in
              last_commit)
                echo "âœ… Dernier commit identifiÃ© avec succÃ¨s"
                ;;
              first_commit)
                echo "âœ… Premier commit identifiÃ© avec succÃ¨s"
                ;;
              all_commits)
                echo "âœ… Historique complet analysÃ© (${{ steps.git_analyze.outputs.total_commits }} commits)"
                ;;
            esac
          else
            echo "   â€¢ RÃ©sultat : Aucun historique Git trouvÃ©"
            echo "âš ï¸  Le chemin spÃ©cifiÃ© n'a pas d'historique Git ou n'est pas suivi"
          fi
          
          # Validation de l'artefact si gÃ©nÃ©rÃ©
          if [ -n "${{ steps.git_analyze.outputs.artefact_file }}" ] && [ -f "${{ steps.git_analyze.outputs.artefact_file }}" ]; then
            echo "ğŸ“„ Artefact crÃ©Ã© : ${{ steps.git_analyze.outputs.artefact_file }}"
            echo "ğŸ“Š Taille : $(stat -c%s "${{ steps.git_analyze.outputs.artefact_file }}") octets"
          fi
          
          echo "âœ… Analyse Git terminÃ©e"
      
      - name: "Affichage du rÃ©sumÃ© dans l'interface"
        if: always()
        run: |
          echo "## ğŸ•°ï¸ Analyse Historique Git" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chemin analysÃ© :** \`${{ inputs.chemin_fichier_ou_dossier }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OpÃ©ration :** ${{ inputs.operation }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.git_analyze.outputs.date_output }}" ]; then
            echo "**âœ… RÃ©sultats :**" >> $GITHUB_STEP_SUMMARY
            echo "- Date : \`${{ steps.git_analyze.outputs.date_output }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Commit : \`${{ steps.git_analyze.outputs.commit_hash }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Auteur : ${{ steps.git_analyze.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY
            echo "- Total commits : ${{ steps.git_analyze.outputs.total_commits }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âš ï¸ RÃ©sultat :** Aucun historique Git trouvÃ©" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Format de sortie :** ${{ inputs.format_sortie }}" >> $GITHUB_STEP_SUMMARY
      
      - name: "Debug - Historique dÃ©taillÃ©"
        if: runner.debug == '1'
        run: |
          echo "ğŸ” Historique Git dÃ©taillÃ© pour : ${{ inputs.chemin_fichier_ou_dossier }}"
          git log --oneline -10 -- "${{ inputs.chemin_fichier_ou_dossier }}" || echo "Aucun historique trouvÃ©"
          
          if [ -n "${{ steps.git_analyze.outputs.artefact_file }}" ] && [ -f "${{ steps.git_analyze.outputs.artefact_file }}" ]; then
            echo "ğŸ” Contenu de l'artefact JSON :"
            cat "${{ steps.git_analyze.outputs.artefact_file }}"
          fi
