name: ğŸ¨ Formatage et Linting AutomatisÃ©s

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_fix:
        description: 'Forcer la correction automatique'
        required: false
        default: 'true'
        type: boolean

env:
  PYTHON_VERSION: '3.9'

jobs:
  python-formatting:
    name: ğŸ Python - Formatage & Linting
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Python Tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort ruff mypy pylint autoflake

    - name: ğŸ§¹ Remove Unused Imports (autoflake)
      run: |
        echo "ğŸ§¹ Suppression des imports inutilisÃ©s..."
        find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" | xargs autoflake \
          --in-place \
          --remove-all-unused-imports \
          --remove-unused-variables \
          --remove-duplicate-keys \
          --ignore-init-module-imports || true

    - name: ğŸ“ Sort Imports (isort)
      run: |
        echo "ğŸ“ Organisation des imports..."
        isort . \
          --profile black \
          --line-length 120 \
          --multi-line 3 \
          --trailing-comma \
          --force-grid-wrap 0 \
          --combine-as \
          --skip venv \
          --skip .git || true

    - name: ğŸ¨ Format Code (Black)
      run: |
        echo "ğŸ¨ Formatage du code Python..."
        black . \
          --line-length 120 \
          --target-version py39 \
          --skip-string-normalization \
          --exclude "(venv/|\.git/)" || true

    - name: âš¡ Lint with Ruff
      run: |
        echo "âš¡ Linting avec Ruff..."
        ruff check . \
          --fix \
          --line-length 120 \
          --target-version py39 \
          --exclude venv \
          --exclude .git \
          --ignore E501,W503,E203 || true

    - name: ğŸ” Type Checking (MyPy)
      run: |
        echo "ğŸ” VÃ©rification des types..."
        mypy . \
          --ignore-missing-imports \
          --no-strict-optional \
          --exclude venv \
          --exclude .git || echo "âš ï¸ Erreurs de types dÃ©tectÃ©es mais non bloquantes"

    - name: ğŸ“Š Advanced Linting (Pylint)
      run: |
        echo "ğŸ“Š Linting avancÃ© avec Pylint..."
        find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" | head -20 | \
        xargs pylint \
          --disable=C0114,C0115,C0116,R0903,R0902,W0613 \
          --max-line-length=120 || echo "âš ï¸ Warnings Pylint dÃ©tectÃ©s mais non bloquants"

    - name: ğŸ›ï¸ Constitutional Compliance Check
      run: |
        echo "ğŸ›ï¸ VÃ©rification conformitÃ© constitutionnelle AGI..."
        VIOLATIONS=0
        echo "ğŸ“ VÃ©rification directive 200 lignes:"
        
        find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" | while read file; do
          lines=$(wc -l < "$file")
          if [ $lines -gt 200 ]; then
            echo "âŒ VIOLATION: $file ($lines lignes, excÃ¨s: $((lines - 200)))"
            VIOLATIONS=$((VIOLATIONS + 1))
          else
            echo "âœ… CONFORME: $file ($lines lignes)"
          fi
        done
        
        echo "ğŸ“Š RÃ©sumÃ© conformitÃ© constitutionnelle effectuÃ©"

    - name: ğŸ’¾ Auto-commit Formatted Code
      run: |
        echo "ğŸ’¾ VÃ©rification des changements aprÃ¨s formatage..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if ! git diff --quiet; then
          echo "ğŸ“ Changements dÃ©tectÃ©s - crÃ©ation du commit..."
          git add .
          git commit -m "ğŸ¨ auto-format: formatage automatique par GitHub Actions

          âœ¨ FORMATAGE APPLIQUÃ‰:
          â€¢ ğŸ§¹ Suppression imports inutilisÃ©s (autoflake)
          â€¢ ğŸ“ Organisation imports (isort)
          â€¢ ğŸ¨ Formatage code Python (Black)
          â€¢ âš¡ Corrections automatiques (Ruff)
          
          ğŸ›ï¸ CONFORMITÃ‰ AGI:
          Formatage selon standards constitutionnels
          
          ğŸ¤– Commit automatique via GitHub Actions"
          
          git push
          echo "âœ… Code formatÃ© et poussÃ© automatiquement"
        else
          echo "â„¹ï¸ Aucun changement - code dÃ©jÃ  parfaitement formatÃ©"
        fi

  web-formatting:
    name: ğŸŒ Web - Formatage (Prettier)
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Install Prettier & Tools
      run: |
        npm install -g prettier @prettier/plugin-xml prettier-plugin-sh

    - name: ğŸ¨ Format Web Files (Prettier)
      run: |
        echo "ğŸ¨ Formatage des fichiers web..."
        
        # Configuration Prettier
        cat > .prettierrc << 'PRETTIER_EOF'
        {
          "semi": true,
          "trailingComma": "es5",
          "singleQuote": true,
          "printWidth": 120,
          "tabWidth": 2,
          "useTabs": false,
          "bracketSpacing": true,
          "arrowParens": "avoid",
          "endOfLine": "lf",
          "overrides": [
            {
              "files": "*.md",
              "options": {
                "proseWrap": "preserve"
              }
            },
            {
              "files": ["*.yml", "*.yaml"],
              "options": {
                "tabWidth": 2
              }
            }
          ]
        }
        PRETTIER_EOF
        
        # Formater les fichiers web
        prettier --write \
          "**/*.{js,jsx,ts,tsx,json,css,scss,html,md,yml,yaml}" \
          --ignore-path .gitignore \
          --log-level warn || echo "âš ï¸ Certains fichiers n'ont pas pu Ãªtre formatÃ©s"

    - name: ğŸ’¾ Auto-commit Web Formatting
      run: |
        echo "ğŸ’¾ VÃ©rification des changements web..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if ! git diff --quiet; then
          echo "ğŸ“ Changements web dÃ©tectÃ©s - crÃ©ation du commit..."
          git add .
          git commit -m "ğŸŒ auto-format: formatage web automatique (Prettier)

          âœ¨ FORMATAGE WEB APPLIQUÃ‰:
          â€¢ ğŸ¨ Formatage JavaScript/TypeScript
          â€¢ ğŸ“ Formatage Markdown
          â€¢ âš™ï¸ Formatage YAML/JSON
          â€¢ ğŸ’„ Formatage CSS/SCSS
          
          ğŸ¤– Commit automatique via GitHub Actions"
          
          git push
          echo "âœ… Fichiers web formatÃ©s et poussÃ©s automatiquement"
        else
          echo "â„¹ï¸ Aucun changement web - fichiers dÃ©jÃ  formatÃ©s"
        fi

  super-linter:
    name: ğŸ” Super Linter (Analyse Globale)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Run Super Linter
      uses: super-linter/super-linter@v6.3.0
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_ALL_CODEBASE: false
        VALIDATE_PYTHON_BLACK: true
        VALIDATE_PYTHON_ISORT: true
        VALIDATE_PYTHON_PYLINT: true
        VALIDATE_PYTHON_RUFF: true
        VALIDATE_MARKDOWN: true
        VALIDATE_YAML: true
        VALIDATE_JSON: true
        VALIDATE_BASH: true
        PYTHON_BLACK_CONFIG_FILE: pyproject.toml
        PYTHON_ISORT_CONFIG_FILE: pyproject.toml
        LOG_LEVEL: WARN

  formatting-report:
    name: ğŸ“Š Rapport de Formatage
    runs-on: ubuntu-latest
    needs: [python-formatting, web-formatting, super-linter]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“Š Generate Formatting Report
      run: |
        echo "ğŸ“Š RAPPORT DE FORMATAGE AUTOMATISÃ‰" >> $GITHUB_STEP_SUMMARY
        echo "=================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¯ **Statut des Jobs:**" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ Python Formatting: ${{ needs.python-formatting.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ Web Formatting: ${{ needs.web-formatting.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” Super Linter: ${{ needs.super-linter.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **ExÃ©cutÃ© le:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ğŸŒ¿ **Branche:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‘¤ **DÃ©clencheur:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ›ï¸ **ConformitÃ© AGI:** Standards constitutionnels appliquÃ©s" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… Rapport de formatage gÃ©nÃ©rÃ© avec succÃ¨s"
