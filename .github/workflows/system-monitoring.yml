name: ðŸ“Š Surveillance Continue du SystÃ¨me

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ExÃ©cution toutes les 6 heures
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  system-health-check:
    name: ðŸ¥ VÃ©rification SantÃ© SystÃ¨me
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psutil requests

    - name: ðŸ” System Health Analysis
      id: health_check
      run: |
        echo "ðŸ¥ Analyse de la santÃ© du systÃ¨me..."
        
        # Statistiques du repository
        echo "ðŸ“Š STATISTIQUES REPOSITORY:" >> health_report.txt
        echo "â€¢ Nombre de fichiers Python: $(find . -name "*.py" | wc -l)" >> health_report.txt
        echo "â€¢ Nombre de workflows: $(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | wc -l)" >> health_report.txt
        echo "â€¢ Taille totale: $(du -sh . | cut -f1)" >> health_report.txt
        echo "" >> health_report.txt
        
        # VÃ©rification conformitÃ© 200 lignes
        echo "ðŸ›ï¸ CONFORMITÃ‰ CONSTITUTIONNELLE:" >> health_report.txt
        VIOLATIONS=0
        TOTAL_FILES=0
        
        find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" -not -path "./backup_*/*" | while read file; do
          lines=$(wc -l < "$file" 2>/dev/null || echo "0")
          TOTAL_FILES=$((TOTAL_FILES + 1))
          if [ "$lines" -gt 200 ]; then
            echo "âŒ VIOLATION: $file ($lines lignes)" >> health_report.txt
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
        done
        
        TOTAL_FILES=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" -not -path "./backup_*/*" | wc -l)
        CONFORMANT=$((TOTAL_FILES - VIOLATIONS))
        CONFORMITY_RATE=$(echo "scale=1; $CONFORMANT * 100 / $TOTAL_FILES" | bc -l 2>/dev/null || echo "0")
        
        echo "â€¢ Fichiers analysÃ©s: $TOTAL_FILES" >> health_report.txt
        echo "â€¢ Fichiers conformes: $CONFORMANT" >> health_report.txt
        echo "â€¢ Taux de conformitÃ©: ${CONFORMITY_RATE}%" >> health_report.txt
        echo "" >> health_report.txt
        
        # VÃ©rification des actions obsolÃ¨tes
        echo "ðŸ”§ VÃ‰RIFICATION WORKFLOWS:" >> health_report.txt
        DEPRECATED_FOUND=0
        
        if [ -d ".github/workflows" ]; then
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              if grep -q "actions/upload-artifact@v3\|actions/checkout@v3\|actions/setup-python@v4" "$workflow"; then
                echo "âš ï¸ Actions obsolÃ¨tes dans: $(basename "$workflow")" >> health_report.txt
                DEPRECATED_FOUND=1
              fi
            fi
          done
        fi
        
        if [ $DEPRECATED_FOUND -eq 0 ]; then
          echo "âœ… Tous les workflows utilisent des actions Ã  jour" >> health_report.txt
        fi
        
        echo "" >> health_report.txt
        echo "â° Rapport gÃ©nÃ©rÃ© le: $(date)" >> health_report.txt
        
        # Afficher le rapport
        cat health_report.txt
        
        # Exporter pour les Ã©tapes suivantes
        echo "conformity_rate=${CONFORMITY_RATE}" >> $GITHUB_OUTPUT
        echo "total_files=${TOTAL_FILES}" >> $GITHUB_OUTPUT

    - name: ðŸ“Š Upload Health Report
      uses: actions/upload-artifact@v4
      with:
        name: system-health-report-${{ github.run_number }}
        path: health_report.txt
        retention-days: 30

    - name: ðŸš¨ Alert on Low Conformity
      if: steps.health_check.outputs.conformity_rate < 90
      run: |
        echo "ðŸš¨ ALERTE: Taux de conformitÃ© bas (${{ steps.health_check.outputs.conformity_rate }}%)"
        echo "Moins de 90% des fichiers respectent la directive 200 lignes"
        echo "Action recommandÃ©e: Refactorisation urgente nÃ©cessaire"

  dependency-security-scan:
    name: ðŸ”’ Scan SÃ©curitÃ© des DÃ©pendances
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ” Security Audit
      run: |
        echo "ðŸ”’ Audit de sÃ©curitÃ© des dÃ©pendances..."
        
        # Installer les outils de sÃ©curitÃ©
        pip install safety bandit
        
        echo "ðŸ›¡ï¸ AUDIT SÃ‰CURITÃ‰:" > security_report.txt
        echo "=================" >> security_report.txt
        echo "" >> security_report.txt
        
        # Scan avec Safety (vulnÃ©rabilitÃ©s dans les dÃ©pendances)
        echo "ðŸ“¦ Scan des dÃ©pendances avec Safety:" >> security_report.txt
        if [ -f "requirements.txt" ]; then
          safety check -r requirements.txt >> security_report.txt 2>&1 || echo "âš ï¸ VulnÃ©rabilitÃ©s dÃ©tectÃ©es dans les dÃ©pendances" >> security_report.txt
        else
          echo "â„¹ï¸ Aucun fichier requirements.txt trouvÃ©" >> security_report.txt
        fi
        
        echo "" >> security_report.txt
        
        # Scan avec Bandit (problÃ¨mes de sÃ©curitÃ© dans le code)
        echo "ðŸ” Scan du code avec Bandit:" >> security_report.txt
        bandit -r . -f txt -o bandit_output.txt 2>/dev/null || true
        if [ -f "bandit_output.txt" ]; then
          cat bandit_output.txt >> security_report.txt
        fi
        
        echo "" >> security_report.txt
        echo "â° Audit gÃ©nÃ©rÃ© le: $(date)" >> security_report.txt
        
        # Afficher le rapport
        cat security_report.txt

    - name: ðŸ“Š Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report-${{ github.run_number }}
        path: security_report.txt
        retention-days: 30

  performance-metrics:
    name: âš¡ MÃ©triques de Performance
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: âš¡ Performance Analysis
      run: |
        echo "âš¡ Analyse des mÃ©triques de performance..."
        
        echo "ðŸ“ˆ MÃ‰TRIQUES PERFORMANCE:" > performance_report.txt
        echo "========================" >> performance_report.txt
        echo "" >> performance_report.txt
        
        # Analyse de la complexitÃ© du code
        pip install radon
        
        echo "ðŸ§® ComplexitÃ© cyclomatique moyenne:" >> performance_report.txt
        find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" | head -20 | \
        xargs radon cc -a >> performance_report.txt 2>/dev/null || echo "Analyse non disponible" >> performance_report.txt
        
        echo "" >> performance_report.txt
        
        # Statistiques gÃ©nÃ©rales
        echo "ðŸ“Š Statistiques gÃ©nÃ©rales:" >> performance_report.txt
        echo "â€¢ Lignes de code Python: $(find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo '0')" >> performance_report.txt
        echo "â€¢ Fichiers de plus de 100 lignes: $(find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" -exec wc -l {} + | awk '$1 > 100 {count++} END {print count+0}')" >> performance_report.txt
        echo "â€¢ Fichiers de plus de 200 lignes: $(find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" -exec wc -l {} + | awk '$1 > 200 {count++} END {print count+0}')" >> performance_report.txt
        
        echo "" >> performance_report.txt
        echo "â° MÃ©triques gÃ©nÃ©rÃ©es le: $(date)" >> performance_report.txt
        
        # Afficher le rapport
        cat performance_report.txt

    - name: ðŸ“Š Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: performance-metrics-${{ github.run_number }}
        path: performance_report.txt
        retention-days: 30

  summary-report:
    name: ðŸ“‹ Rapport de SynthÃ¨se
    runs-on: ubuntu-latest
    needs: [system-health-check, dependency-security-scan, performance-metrics]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        echo "ðŸ“‹ RAPPORT DE SYNTHÃˆSE - SURVEILLANCE SYSTÃˆME" >> $GITHUB_STEP_SUMMARY
        echo "=============================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Statut des VÃ©rifications:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ¥ SantÃ© SystÃ¨me: ${{ needs.system-health-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ Audit SÃ©curitÃ©: ${{ needs.dependency-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ MÃ©triques Performance: ${{ needs.performance-metrics.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **MÃ©triques ClÃ©s:**" >> $GITHUB_STEP_SUMMARY
        echo "- ConformitÃ© constitutionnelle: ${{ needs.system-health-check.outputs.conformity_rate }}%" >> $GITHUB_STEP_SUMMARY
        echo "- Fichiers analysÃ©s: ${{ needs.system-health-check.outputs.total_files }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **ExÃ©cutÃ© le:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ¿ **Branche:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **DÃ©clencheur:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ›ï¸ **ConformitÃ© AGI:** Surveillance continue selon standards constitutionnels" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… Rapport de synthÃ¨se gÃ©nÃ©rÃ© avec succÃ¨s"
