name: ðŸ¤– Auto-Refactorisation Constitutionnelle

on:
  push:
    branches: [ agi-main, eve-main ]
  schedule:
    - cron: '0 3 * * *'  # 3h du matin chaque jour
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Mode simulation (true/false)'
        required: false
        default: 'true'
      max_files:
        description: 'Nombre max de fichiers Ã  traiter'
        required: false
        default: '5'

jobs:
  auto-refactor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ” Scanner Violations
      id: scan
      run: |
        echo "ðŸ” DÃ©tection violations constitutionnelles..."
        python agi_project/tools/auto_refactor.py --scan --project-root . --max-lines 200 > scan_results.txt
        
        VIOLATIONS=$(grep -c "ðŸ“„.*lignes" scan_results.txt || echo "0")
        echo "violations_count=$VIOLATIONS" >> $GITHUB_OUTPUT
        
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "changes_needed=true" >> $GITHUB_OUTPUT
          echo "ðŸš¨ $VIOLATIONS violations dÃ©tectÃ©es"
        else
          echo "changes_needed=false" >> $GITHUB_OUTPUT
          echo "âœ… Aucune violation dÃ©tectÃ©e"
        fi
        
        cat scan_results.txt
    
    - name: ðŸ“‹ Upload Rapport
      uses: actions/upload-artifact@v4
      with:
        name: scan-violations-report
        path: scan_results.txt
        retention-days: 7
    
    - name: ðŸ“¢ RÃ©sumÃ© Violations
      if: steps.scan.outputs.changes_needed == 'true'
      run: |
        echo "## ðŸš¨ Violations Constitutionnelles DÃ©tectÃ©es" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Nombre total:** ${{ steps.scan.outputs.violations_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Top 10 Violations:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        head -20 scan_results.txt | tail -10 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ Utilisez 'Run workflow' avec dry_run=false pour corriger automatiquement" >> $GITHUB_STEP_SUMMARY
# Workflow auto-refactor test - dim. 21 sept. 2025 21:08:06 CEST
