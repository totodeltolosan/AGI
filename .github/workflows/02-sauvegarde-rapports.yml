name: "🗄️ Général L'Archiviste en Chef - Sauvegarde Rapports"

on:
  workflow_call:
    inputs:
      noms_artefacts:
        description: "Liste des noms d'artefacts à sauvegarder (JSON string)"
        required: true
        type: string
      nom_archive:
        description: "Nom de l'archive finale à créer"
        required: true
        type: string
    outputs:
      statut_sauvegarde:
        description: "Statut de la sauvegarde (success/failure)"
        value: ${{ jobs.sauvegarde-rapports.outputs.statut }}
      archive_finale:
        description: "Nom de l'archive créée"
        value: ${{ inputs.nom_archive }}

jobs:
  sauvegarde-rapports:
    name: "🗄️ Sauvegarde Complète Rapports"
    runs-on: ubuntu-latest
    
    outputs:
      statut: ${{ steps.contremaître.outputs.statut }}
    
    steps:
      - name: "📁 Téléchargement du code source"
        uses: actions/checkout@v4

      - name: "🐍 Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "🗄️ Exécution du Contremaître Sauvegarde"
        id: contremaître
        run: |
          echo "🎯 === GÉNÉRAL L'ARCHIVISTE EN CHEF ==="
          echo "Artefacts à sauvegarder: ${{ inputs.noms_artefacts }}"
          echo "Archive finale: ${{ inputs.nom_archive }}"
          echo ""
          
          # Exécution du script Contremaître
          python .github/scripts/sauvegarde_rapports.py \
            --artefacts '${{ inputs.noms_artefacts }}' \
            --nom-archive "${{ inputs.nom_archive }}"
          
          # Capture du code de retour
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "statut=success" >> $GITHUB_OUTPUT
            echo "✅ Sauvegarde rapports terminée avec succès"
          else
            echo "statut=failure" >> $GITHUB_OUTPUT
            echo "❌ Sauvegarde rapports échouée"
          fi

      - name: "📊 Publication du résumé de sauvegarde"
        if: always()
        run: |
          echo "## 🗄️ Sauvegarde Rapports - Résultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artefacts sauvegardés :** $(echo '${{ inputs.noms_artefacts }}' | jq '. | length') artefact(s)" >> $GITHUB_STEP_SUMMARY
          echo "**Archive créée :** ${{ inputs.nom_archive }}" >> $GITHUB_STEP_SUMMARY
          echo "**Statut final :** ${{ steps.contremaître.outputs.statut }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.contremaître.outputs.statut }}" = "success" ]; then
            echo "✅ **Sauvegarde réussie** - Tous les rapports archivés" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Sauvegarde échouée** - Problème lors de l'archivage" >> $GITHUB_STEP_SUMMARY
          fi
