name: "Travailleur : Applicateur Regex"

on:
  workflow_call:
    inputs:
      contenu:
        description: "Contenu textuel Ã  analyser ou chemin vers un fichier"
        required: true
        type: string
      regle_regex:
        description: "Configuration JSON de la rÃ¨gle regex (pattern, flags, nom, etc.)"
        required: true
        type: string
      nom_artefact:
        description: "Nom de l'artefact JSON de sortie"
        required: false
        default: "resultats-regex.json"
        type: string
    outputs:
      correspondances_trouvees:
        description: "Nombre de correspondances trouvÃ©es"
        value: ${{ jobs.apply_regex.outputs.match_count }}
      artefact_path:
        description: "Chemin vers l'artefact des rÃ©sultats"
        value: ${{ jobs.apply_regex.outputs.artifact_path }}

jobs:
  apply_regex:
    name: "Application expression rÃ©guliÃ¨re"
    runs-on: ubuntu-latest
    outputs:
      match_count: ${{ steps.regex.outputs.match_count }}
      artifact_path: ${{ steps.regex.outputs.artifact_path }}
    
    steps:
      - name: "Checkout du code"
        uses: actions/checkout@v5
      
      - name: "Configuration Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: "Installation des dÃ©pendances Python"
        run: |
          python -m pip install --upgrade pip
          # Utilise seulement la stdlib Python (module re)
      
      - name: "Validation de la rÃ¨gle regex"
        run: |
          echo "ğŸ” Validation de la configuration regex :"
          python -c "import json; import sys; try:; regle = json.loads('${{ inputs.regle_regex }}'); print(f'âœ… Pattern: {regle.get(\\"pattern\\", \\"NON DÃ‰FINI\\")}'); print(f'   Nom: {regle.get(\\"nom\\", \\"regex_search\\")}'); print(f'   Flags: {regle.get(\\"flags\\", [])}'); if 'pattern' not in regle:; print('âŒ ERREUR: Champ \\"pattern\\" requis manquant'); sys.exit(1); except json.JSONDecodeError as e:; print(f'âŒ ERREUR: JSON invalide - {e}'); sys.exit(1); except Exception as e:; print(f'âŒ ERREUR: Validation Ã©chouÃ©e - {e}'); sys.exit(1)"
      - name: "PrÃ©paration du contenu d'entrÃ©e"
        id: prepare_content
        run: |
          # Si le contenu semble Ãªtre un chemin de fichier, vÃ©rifier son existence
          if [ -f "${{ inputs.contenu }}" ]; then
            echo "ğŸ“ Fichier dÃ©tectÃ© : ${{ inputs.contenu }}"
            echo "ğŸ“Š Taille : $(stat -c%s "${{ inputs.contenu }}") octets"
            echo "content_type=file" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ Contenu textuel direct ($(echo '${{ inputs.contenu }}' | wc -c) caractÃ¨res)"
            echo "content_type=text" >> $GITHUB_OUTPUT
          fi
      
      - name: "ExÃ©cution de l'applicateur regex"
        id: regex
        run: |
          python .github/scripts/travailleur_regex_applicateur.py \
            --contenu "${{ inputs.contenu }}" \
            --regle-regex '${{ inputs.regle_regex }}' \
            --sortie "${{ inputs.nom_artefact }}"
          
          # Extraction du nombre de correspondances pour les outputs
          if [ -f "${{ inputs.nom_artefact }}" ]; then
            count=$(python -c "import json; data=json.load(open('${{ inputs.nom_artefact }}')); print(data.get('total_correspondances', 0))")
            echo "match_count=$count" >> $GITHUB_OUTPUT
            echo "artifact_path=${{ inputs.nom_artefact }}" >> $GITHUB_OUTPUT
            echo "ğŸ¯ $count correspondances trouvÃ©es"
          else
            echo "match_count=0" >> $GITHUB_OUTPUT
            echo "âŒ ERREUR: Artefact de rÃ©sultats non crÃ©Ã©"
            exit 1
          fi
      
      - name: "Upload de l'artefact rÃ©sultats regex"
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.nom_artefact }}
          path: ${{ inputs.nom_artefact }}
          retention-days: 30
      
      - name: "Rapport d'analyse et validation"
        run: |
          if [ -f "${{ inputs.nom_artefact }}" ]; then
            echo "ğŸ“„ Artefact crÃ©Ã© : ${{ inputs.nom_artefact }}"
            echo "ğŸ“Š Taille : $(stat -c%s "${{ inputs.nom_artefact }}") octets"
            
            # Affichage d'un rÃ©sumÃ© de l'analyse
            echo "ğŸ” RÃ©sumÃ© de l'analyse regex :"
            python -c "import json; with open('${{ inputs.nom_artefact }}', 'r') as f:; data = json.load(f); regle = data['regle']; stats = data['contenu_stats']; print(f'   â€¢ Pattern : {regle[\\"pattern\\"]}'); print(f'   â€¢ Nom rÃ¨gle : {regle.get(\\"nom\\", \\"N/A\\")}'); print(f'   â€¢ Flags : {regle.get(\\"flags\\", [])}'); print(f'   â€¢ Contenu analysÃ© : {stats[\\"taille_caracteres\\"]} caractÃ¨res, {stats[\\"lignes\\"]} lignes'); print(f'   â€¢ Total correspondances : {data[\\"total_correspondances\\"]}'); if data['correspondances']:; print('   â€¢ Ã‰chantillon des correspondances :'); for i, match in enumerate(data['correspondances'][:3]):; print(f'     - Ligne {match[\\"ligne\\"]}: \\"{match[\\"match_complet\\"][:40]}\\"'); if len(data['correspondances']) > 3:; print(f'     ... et {len(data[\\"correspondances\\"]) - 3} autres')"
          else
            echo "âŒ ERREUR: Fichier de rÃ©sultats non trouvÃ©"
            exit 1
          fi
          
          echo "âœ… Application regex terminÃ©e avec succÃ¨s"
      
      - name: "Debug - Validation structure JSON"
        if: runner.debug == '1'
        run: |
          echo "ğŸ” Validation de la structure JSON des rÃ©sultats :"
          python -c "import json; import sys; try:; with open('${{ inputs.nom_artefact }}', 'r') as f:; data = json.load(f); ; required_keys = ['regle', 'timestamp', 'contenu_stats', 'total_correspondances', 'correspondances']; for key in required_keys:; if key not in data:; print(f'âŒ ClÃ© manquante : {key}'); sys.exit(1); else:; print(f'âœ… {key}: OK'); ; print('âœ… Structure JSON valide'); except Exception as e:; print(f'âŒ Erreur validation JSON : {e}'); sys.exit(1)"