name: ðŸ” GAIA Code Analysis Integration

on:
  push:
    paths: ['eve/development/code_analysis/**', '**/*.py']
  pull_request:
    paths: ['**/*.py']
  schedule:
    - cron: '0 */6 * * *'

jobs:
  gaia-analysis:
    name: GAIA PrometheusCore Analysis
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup GAIA Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install GAIA Dependencies
      run: |
        pip install ast-analyze code-complexity-tools
        pip install radon vulture bandit safety
        pip install tree-sitter-python pygments
        
    - name: GAIA PrometheusCore Integration Test
      run: |
        cd eve/development/code_analysis/
        
        echo "ðŸ” TEST GAIA PROMETHEUS CORE"
        python -c "
        try:
            from prometheus_core import PrometheusAnalyzer
            from code_hunter import CodeHunter
            
            # Initialiser GAIA
            prometheus = PrometheusAnalyzer()
            hunter = CodeHunter()
            
            print('âœ… GAIA PrometheusCore: Initialisation OK')
            
            # Test analyse de code
            test_code = '''
def test_function():
    x = 1 + 1
    return x
'''
            analysis = prometheus.analyze_code(test_code)
            print('âœ… GAIA: Analyse de code fonctionnelle')
            
        except Exception as e:
            print(f'âš ï¸ GAIA Integration: {e}')
            print('Note: Modules GAIA en migration')
        "
        
    - name: Run GAIA on Entire Codebase
      run: |
        echo "ðŸ” ANALYSE GAIA COMPLÃˆTE DU PROJET" > gaia-analysis.md
        echo "==================================" >> gaia-analysis.md
        echo "" >> gaia-analysis.md
        
        # Analyser avec outils disponibles
        echo "## ðŸ“Š MÃ©triques Globales" >> gaia-analysis.md
        
        total_py_files=$(find . -name "*.py" -not -path "./.git/*" | wc -l)
        total_lines=$(find . -name "*.py" -not -path "./.git/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
        
        echo "- **Fichiers Python**: $total_py_files" >> gaia-analysis.md
        echo "- **Lignes totales**: $total_lines" >> gaia-analysis.md
        echo "" >> gaia-analysis.md
        
        # ComplexitÃ© avec radon
        echo "## ðŸ§® Analyse ComplexitÃ© (Radon)" >> gaia-analysis.md
        radon cc . -a -nc --total-average > radon_complexity.txt 2>/dev/null || echo "Analyse complexitÃ© en cours..." > radon_complexity.txt
        head -20 radon_complexity.txt >> gaia-analysis.md
        echo "" >> gaia-analysis.md
        
        # Code mort avec vulture
        echo "## ðŸ” Code InutilisÃ© (Vulture)" >> gaia-analysis.md
        vulture . --min-confidence 80 | head -10 >> gaia-analysis.md 2>/dev/null || echo "Analyse code mort en cours..." >> gaia-analysis.md
        echo "" >> gaia-analysis.md
        
        # SÃ©curitÃ© avec bandit
        echo "## ðŸ›¡ï¸ Analyse SÃ©curitÃ© (Bandit)" >> gaia-analysis.md
        bandit -r . -f txt | head -20 >> gaia-analysis.md 2>/dev/null || echo "Analyse sÃ©curitÃ© en cours..." >> gaia-analysis.md
        
    - name: GAIA Integration with AGI Compliance
      run: |
        echo "" >> gaia-analysis.md
        echo "## ðŸ¤ IntÃ©gration GAIA-AGI" >> gaia-analysis.md
        
        # VÃ©rifier intÃ©gration avec systÃ¨me de conformitÃ© AGI
        if [ -f "core/compliance/audit_constitutionnel.py" ]; then
          echo "âœ… **Audit Constitutionnel**: DÃ©tectÃ©" >> gaia-analysis.md
          
          # Test intÃ©gration
          python -c "
          import sys
          sys.path.append('core/compliance')
          sys.path.append('eve/development/code_analysis')
          
          try:
              # Test import croisÃ©
              from audit_constitutionnel import AuditeurConstitutionnel
              
              auditor = AuditeurConstitutionnel()
              print('âœ… IntÃ©gration GAIA-AGI: Fonctionnelle')
              
              # Test analyse intÃ©grÃ©e
              if hasattr(auditor, 'analyser_avec_gaia'):
                  print('âœ… MÃ©thode GAIA intÃ©grÃ©e: Disponible')
              else:
                  print('âš ï¸ MÃ©thode GAIA: Ã€ dÃ©velopper')
                  
          except Exception as e:
              print(f'âš ï¸ IntÃ©gration GAIA-AGI: {e}')
          " >> gaia-analysis.md
          
        else
          echo "âš ï¸ **Audit Constitutionnel**: Non trouvÃ©" >> gaia-analysis.md
        fi
        
    - name: Upload GAIA Analysis
      uses: actions/upload-artifact@v3
      with:
        name: gaia-code-analysis
        path: |
          gaia-analysis.md
          radon_complexity.txt
